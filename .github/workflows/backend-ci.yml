name: ðŸ Backend CI/CD
on:
  push:
    branches: [develop, main]
    paths:
      - 'packages/backend/**'
      - 'config/**'
      - 'scripts/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [develop, main]
    paths:
      - 'packages/backend/**'
      - 'config/**'
      - 'scripts/**'

# Cancel previous runs on new push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

jobs:
  # ============================================================================
  # SETUP & VALIDATION
  # ============================================================================
  setup:
    name: ðŸ”§ Setup & Validation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      python-version: ${{ steps.env.outputs.python-version }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Detect environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
          else
            echo "environment=testing" >> $GITHUB_OUTPUT
          fi
          echo "python-version=${{ env.PYTHON_VERSION }}" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Environment Info
        run: |
          echo "ðŸ” Environment detected: ${{ steps.env.outputs.environment }}"
          echo "ðŸ Python version: ${{ steps.env.outputs.python-version }}"
          echo "ðŸ“ Triggered by: ${{ github.event_name }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"

  # ============================================================================
  # PYTHON TESTS & QUALITY
  # ============================================================================
  backend-tests:
    name: ðŸ§ª Backend Tests
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        test-type: [unit, integration, quality]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ needs.setup.outputs.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          cache: 'pip'
          cache-dependency-path: packages/backend/requirements.txt

      - name: ðŸ“¦ Install dependencies
        run: |
          cd packages/backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ”§ Setup temporary .env.test for testing
        env:
          ENVIRONMENT: ${{ needs.setup.outputs.environment }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd packages/backend
          echo "ENVIRONMENT=$ENVIRONMENT" > .env.test
          echo "DEBUG=true" >> .env.test
          echo "SUPABASE_URL=${SUPABASE_URL:-https://placeholder.supabase.co}" >> .env.test
          echo "SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-placeholder-key}" >> .env.test
          echo "FIREBASE_PROJECT_ID=taxasge-$ENVIRONMENT" >> .env.test

      - name: ðŸ§ª Run unit tests
        if: matrix.test-type == 'unit'
        run: |
          cd packages/backend
          python -m pytest tests/ -v --tb=short --cov=app --cov-report=xml --cov-report=term-missing --env-file=.env.test

      - name: ðŸ”— Run integration tests
        if: matrix.test-type == 'integration'
        run: |
          cd packages/backend
          python -c "
          print('ðŸ” Testing imports...')
          from app.config import settings
          print(f'âœ… Config loaded: {settings.ENVIRONMENT}')
          import fastapi
          print(f'âœ… FastAPI version: {fastapi.__version__}')
          from app import __version__
          print(f'âœ… App version: {__version__}')
          print('ðŸŽ‰ All integration tests passed!')
          " --env-file=.env.test

      - name: ðŸ” Code quality checks
        if: matrix.test-type == 'quality'
        run: |
          cd packages/backend
          echo "ðŸ” Running flake8..."
          flake8 app/ --max-line-length=100 --extend-ignore=E203,W503
          echo "ðŸ” Running black check..."
          black --check app/ --diff
          echo "ðŸ” Running isort check..."
          isort --check-only app/ --diff
          echo "âœ… All quality checks passed!"

      - name: ðŸ“Š Upload coverage to Codecov
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          file: packages/backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: ðŸ—‘ï¸ Remove temporary .env.test
        if: always()
        run: |
          cd packages/backend
          rm -f .env.test

  # ============================================================================
  # API VALIDATION
  # ============================================================================
  api-validation:
    name: ðŸš€ API Validation
    runs-on: ubuntu-latest
    needs: [setup, backend-tests]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ needs.setup.outputs.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          cache: 'pip'
          cache-dependency-path: packages/backend/requirements.txt

      - name: ðŸ“¦ Install dependencies
        run: |
          cd packages/backend
          pip install -r requirements.txt

      - name: ðŸ”§ Generate backend configuration
        env:
          ENVIRONMENT: ${{ needs.setup.outputs.environment }}
        run: |
          python scripts/setup-backend.py --environment $ENVIRONMENT

      - name: ðŸš€ Start API server
        run: |
          cd packages/backend
          python main.py &
          API_PID=$!
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          echo "â³ Waiting for API to start..."
          timeout 30 bash -c 'until curl -f http://localhost:8000/health; do sleep 1; done'

      - name: ðŸ§ª Test API endpoints
        run: |
          echo "ðŸ” Testing API endpoints..."
          echo "ðŸ“¡ Testing root endpoint..."
          curl -f http://localhost:8000/ | jq .
          echo "ðŸ¥ Testing health endpoint..."
          HEALTH=$(curl -f http://localhost:8000/health)
          echo $HEALTH | jq .
          STATUS=$(echo $HEALTH | jq -r .status)
          if [[ "$STATUS" != "healthy" ]]; then
            echo "âŒ Health check failed: $STATUS"
            exit 1
          fi
          echo "ðŸ“‹ Testing API v1 endpoint..."
          curl -f http://localhost:8000/api/v1/ | jq .
          echo "âœ… All API tests passed!"

      - name: ðŸ›‘ Stop API server
        if: always()
        run: |
          if [[ -n "$API_PID" ]]; then
            kill $API_PID || true
          fi

  # ============================================================================
  # SECURITY SCAN
  # ============================================================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ needs.setup.outputs.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: ðŸ“¦ Install security tools
        run: |
          pip install bandit safety

      - name: ðŸ” Run Bandit security scan
        run: |
          cd packages/backend
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ --severity-level medium

      - name: ðŸ” Check for known vulnerabilities
        run: |
          cd packages/backend
          safety check --json --output safety-report.json || true
          safety check

      - name: ðŸ“Š Upload security reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-reports-${{ needs.setup.outputs.environment }}
          path: |
            packages/backend/bandit-report.json
            packages/backend/safety-report.json

  # ============================================================================
  # SONARQUBE ANALYSIS
  # ============================================================================
  sonarqube:
    name: ðŸ“Š SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [setup, backend-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“Š SonarQube Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: packages/backend

  # ============================================================================
  # NOTIFICATION
  # ============================================================================
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [setup, backend-tests, api-validation, security-scan, sonarqube]
    if: always()

    steps:
      - name: Check if SLACK_WEBHOOK_URL is set
        id: check-secret
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "has_slack_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_slack_webhook=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Determine status
        id: status
        run: |
          if [[ "${{ needs.backend-tests.result }}" == "success" && "${{ needs.api-validation.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "color=#00d084" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "color=#ff4757" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¢ Slack notification
        if: steps.check-secret.outputs.has_slack_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} TaxasGE Backend CI - ${{ steps.status.outputs.status }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "${{ needs.setup.outputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                      "short": true
                    },
                    {
                      "title": "Author",
                      "value": "${{ github.actor }}",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# ============================================================================
# WORKFLOW SUMMARY
# ============================================================================
# Ce workflow Backend CI/CD pour TaxasGE effectue:
# 1. ðŸ”§ Setup & dÃ©tection d'environnement automatique
# 2. ðŸ§ª Tests unitaires, intÃ©gration et qualitÃ© de code
# 3. ðŸš€ Validation API avec tests endpoints complets
# 4. ðŸ”’ Scan de sÃ©curitÃ© avec Bandit et Safety
# 5. ðŸ“Š Analyse SonarQube pour la qualitÃ©
# 6. ðŸ“¢ Notifications Slack des rÃ©sultats
#
# DÃ©clenchÃ© sur: push/PR vers develop/main avec changements backend
# Compatible avec: GitHub Secrets configurÃ©s (Supabase, Slack, SonarQube)
# ============================================================================
