# .github/workflows/deploy-backend.yml
# .github/workflows/deploy-backend.yml
name: Deploy Backend to Firebase

on:
  # Se dÃ©clenche uniquement quand du code est fusionnÃ© dans 'develop'
  push:
    branches:
      - develop
    paths:
      - 'packages/backend/**'  # Optimisation: seulement si backend modifiÃ©

jobs:
  deploy:
    name: ğŸš€ Deploy to Firebase
    runs-on: ubuntu-latest
    # âœ… GARDÃ‰: condition de branche
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js (Firebase CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ”¥ Setup Firebase CLI
        run: npm install -g firebase-tools
      
      # âœ… NOUVEAU : VÃ©rification de l'existence de firebase.json
      - name: ğŸ” Check Firebase Configuration
        run: |
          if [ ! -f "firebase.json" ]; then
            echo "âš ï¸  firebase.json not found - initializing Firebase project"
            echo "ğŸ“ Creating minimal firebase.json for Functions deployment"
            
            # CrÃ©ation d'un firebase.json minimal
            cat > firebase.json << 'EOF'
          {
            "functions": {
              "source": "packages/backend",
              "runtime": "python311",
              "ignore": [
                "**/node_modules/**",
                "**/*.pyc",
                "**/__pycache__/**",
                "**/venv/**",
                "**/env/**"
              ]
            },
            "hosting": {
              "public": "public",
              "ignore": [
                "firebase.json",
                "**/.*",
                "**/node_modules/**"
              ],
              "rewrites": [
                {
                  "source": "/api/**",
                  "function": "main"
                },
                {
                  "source": "**",
                  "destination": "/index.html"
                }
              ]
            }
          }
          EOF
            
            # CrÃ©ation du dossier public minimal
            mkdir -p public
            cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>TaxasGE API</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
              .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
            </style>
          </head>
          <body>
            <h1>ğŸš€ TaxasGE Backend API</h1>
            <div class="status success">
              <p>âœ… Deployment successful!</p>
              <p>ğŸ“… Deployed: <span id="timestamp"></span></p>
              <p>ğŸŒ¿ Branch: develop</p>
            </div>
            
            <h2>ğŸ“¡ Available Endpoints</h2>
            <ul>
              <li><a href="/api/health" target="_blank">/api/health</a> - Health check</li>
              <li><a href="/api/main" target="_blank">/api/main</a> - Main API info</li>
              <li>/api/taxes - Tax information (coming soon)</li>
              <li>/api/chatbot - AI Chatbot (coming soon)</li>
            </ul>
            
            <h2>ğŸ”— Resources</h2>
            <ul>
              <li><a href="https://github.com/your-username/taxasge" target="_blank">GitHub Repository</a></li>
              <li><a href="https://console.firebase.google.com/project/taxasge-dev" target="_blank">Firebase Console</a></li>
            </ul>
            
            <script>
              document.getElementById('timestamp').textContent = new Date().toISOString();
            </script>
          </body>
          </html>
          EOF
            
            echo "âœ… Firebase configuration initialized"
          else
            echo "âœ… firebase.json found - proceeding with deployment"
          fi
      
      # âœ… NOUVEAU : VÃ©rification de la structure backend
      - name: ğŸ” Check Backend Structure
        run: |
          if [ ! -f "packages/backend/main.py" ]; then
            echo "âš ï¸  Backend entry point not found - creating placeholder"
            mkdir -p packages/backend
            
            cat > packages/backend/main.py << 'EOF'
          """
          TaxasGE Backend API - Firebase Functions Entry Point
          Placeholder until real backend implementation
          """
          from firebase_functions import https_fn
          from firebase_admin import initialize_app
          import json
          from datetime import datetime
          
          # Initialize Firebase Admin
          initialize_app()
          
          @https_fn.on_request()
          def main(req: https_fn.Request) -> https_fn.Response:
              """Main API entry point"""
              response_data = {
                  "status": "success",
                  "message": "ğŸš€ TaxasGE Backend API is running!",
                  "version": "0.1.0-dev",
                  "timestamp": datetime.now().isoformat(),
                  "endpoints": [
                      {"path": "/api/health", "description": "Health check endpoint"},
                      {"path": "/api/taxes", "description": "Tax information (coming soon)"},
                      {"path": "/api/chatbot", "description": "AI Chatbot (coming soon)"},
                      {"path": "/api/payments", "description": "Payment processing (coming soon)"}
                  ],
                  "database": {
                      "type": "PostgreSQL",
                      "status": "Planning phase"
                  }
              }
              
              return https_fn.Response(
                  json.dumps(response_data, indent=2),
                  status=200,
                  headers={
                      "Content-Type": "application/json",
                      "Access-Control-Allow-Origin": "*",
                      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
                      "Access-Control-Allow-Headers": "Content-Type, Authorization"
                  }
              )
          
          @https_fn.on_request()
          def health(req: https_fn.Request) -> https_fn.Response:
              """Health check endpoint"""
              health_data = {
                  "status": "healthy",
                  "timestamp": datetime.now().isoformat(),
                  "version": "0.1.0-dev",
                  "environment": "development",
                  "services": {
                      "firebase": "âœ… Connected",
                      "postgresql": "â³ Planning phase",
                      "ai_model": "âœ… Ready (0.41MB)"
                  }
              }
              
              return https_fn.Response(
                  json.dumps(health_data, indent=2),
                  status=200,
                  headers={
                      "Content-Type": "application/json",
                      "Access-Control-Allow-Origin": "*"
                  }
              )
          
          @https_fn.on_request()
          def taxes(req: https_fn.Request) -> https_fn.Response:
              """Taxes endpoint placeholder"""
              return https_fn.Response(
                  json.dumps({
                      "message": "ğŸ—ï¸ Taxes API endpoint in development",
                      "planned_features": [
                          "547 types of taxes",
                          "Multilingual support (ES/FR/EN)",
                          "Search by keywords",
                          "Tax calculator"
                      ],
                      "status": "coming_soon"
                  }, indent=2),
                  status=200,
                  headers={"Content-Type": "application/json"}
              )
          EOF
            
            # Requirements minimal pour Firebase Functions
            cat > packages/backend/requirements.txt << 'EOF'
          firebase-functions>=0.1.0
          firebase-admin>=6.0.0
          functions-framework>=3.0.0
          EOF
            
            echo "âœ… Backend placeholder created"
          else
            echo "âœ… Backend files found"
          fi
      
      # âœ… Authentification sÃ©curisÃ©e (corrigÃ©e)
      - name: ğŸ”‘ Authenticate Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
        run: |
          # VÃ©rification que le secret existe
          if [ -z "$FIREBASE_SERVICE_ACCOUNT" ]; then
            echo "âŒ FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV secret not found"
            echo "Please configure this secret in GitHub repository settings"
            exit 1
          fi
          
          # CrÃ©ation sÃ©curisÃ©e du fichier credentials
          echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-sa.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/firebase-sa.json"
          
          # VÃ©rification de l'authentification
          echo "ğŸ” Testing Firebase authentication..."
          firebase projects:list --project taxasge-dev
          
          if [ $? -eq 0 ]; then
            echo "âœ… Firebase authentication successful"
          else
            echo "âŒ Firebase authentication failed"
            rm -f /tmp/firebase-sa.json
            exit 1
          fi
      
      # âœ… DÃ©ploiement avec gestion d'erreur
      - name: ğŸš€ Deploy Backend Functions
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
          # âœ… AJOUT DES VARIABLES SUPABASE
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/firebase-sa.json"
          
          echo "::group::Firebase Deploy"
          
          # VÃ©rification de la structure avant dÃ©ploiement
          echo "ğŸ“‹ Pre-deployment checks:"
          echo "- firebase.json exists: $([ -f firebase.json ] && echo 'âœ…' || echo 'âŒ')"
          echo "- main.py exists: $([ -f packages/backend/main.py ] && echo 'âœ…' || echo 'âŒ')"
          echo "- requirements.txt exists: $([ -f packages/backend/requirements.txt ] && echo 'âœ…' || echo 'âŒ')"
          
          # DÃ©ploiement avec retry en cas d'Ã©chec
          echo "ğŸš€ Starting deployment..."
          for i in {1..3}; do
            echo "Attempt $i/3..."
            if firebase deploy --only functions --project taxasge-dev --non-interactive --json; then
              echo "âœ… Deployment successful on attempt $i"
              break
            else
              echo "âŒ Deployment failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "ğŸ’¥ Deployment failed after 3 attempts"
                echo "::endgroup::"
                rm -f /tmp/firebase-sa.json
                exit 1
              fi
              echo "â³ Waiting 15 seconds before retry..."
              sleep 15
            fi
          done
          echo "::endgroup::"
          
          # Nettoyage sÃ©curisÃ©
          rm -f /tmp/firebase-sa.json
      
      # âœ… Test de santÃ© amÃ©liorÃ©
      - name: ğŸ§ª Post-Deploy Health Check
        run: |
          echo "::group::API Health Check"
          
          # Attendre que le dÃ©ploiement soit effectif
          echo "â³ Waiting for deployment to be active (60 seconds)..."
          sleep 60
          
          # Test endpoint de santÃ©
          HEALTH_URL="https://taxasge-dev.web.app/api/health"
          MAIN_URL="https://taxasge-dev.web.app/api/main"
          
          echo "ğŸ” Testing endpoints:"
          echo "- Health: $HEALTH_URL"
          echo "- Main: $MAIN_URL"
          
          # Test health endpoint
          echo "Testing health endpoint..."
          for i in {1..5}; do
            if curl -f -s "$HEALTH_URL" | jq . > /dev/null 2>&1; then
              echo "âœ… Health check passed on attempt $i"
              curl -s "$HEALTH_URL" | jq .
              break
            else
              echo "âš ï¸  Health check failed on attempt $i, retrying in 15s..."
              if [ $i -eq 5 ]; then
                echo "âŒ Health check failed after 5 attempts"
                echo "ğŸŒ Trying direct curl without JSON parsing..."
                curl -v "$HEALTH_URL" || true
              fi
              sleep 15
            fi
          done
          
          # Test main endpoint
          echo "Testing main endpoint..."
          if curl -f -s "$MAIN_URL" > /dev/null 2>&1; then
            echo "âœ… Main endpoint is accessible"
          else
            echo "âš ï¸  Main endpoint test failed (non-critical)"
          fi
          
          echo "::endgroup::"
      
      # âœ… Notification de succÃ¨s
      - name: ğŸ“¢ Deployment Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“ Your API is available at:"
          echo "   - Main: https://taxasge-dev.web.app/api/main"
          echo "   - Health: https://taxasge-dev.web.app/api/health"
          echo "   - Dashboard: https://taxasge-dev.web.app"
          echo ""
          echo "ğŸ”— Firebase Console: https://console.firebase.google.com/project/taxasge-dev"
