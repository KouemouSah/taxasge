---
name: ğŸš€ Deploy Backend to Firebase

on:
  push:
    branches: [develop, main]
    paths: 
      - 'src/**'
      - '*.py'
      - 'requirements.txt'
      - 'firebase.json'
      - 'main.py'
      - 'config/**'
      - 'scripts/**'

jobs:
  deploy:
    name: ğŸš€ Deploy to Firebase
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          # Node.js dependencies for Firebase CLI
          npm install -g firebase-tools
          
          # Python dependencies
          pip install -r requirements.txt
      
      # âœ… SIMPLIFICATION: VÃ©rification des fichiers de configuration
      - name: ğŸ” Validate Configuration Files
        run: |
          echo "ğŸ” Validating configuration files..."
          
          # VÃ©rification firebase.json
          if [ ! -f "firebase.json" ]; then
            echo "âŒ firebase.json not found in repository"
            echo "Please commit firebase.json to the repository"
            exit 1
          fi
          
          # VÃ©rification config/environments.json
          if [ ! -f "config/environments.json" ]; then
            echo "âŒ config/environments.json not found"
            echo "Please commit configuration files to the repository"
            exit 1
          fi
          
          # VÃ©rification script setup
          if [ ! -f "scripts/setup-firebase.js" ]; then
            echo "âŒ scripts/setup-firebase.js not found"
            echo "Please commit setup scripts to the repository"
            exit 1
          fi
          
          # Validation JSON syntax
          python -m json.tool firebase.json > /dev/null || {
            echo "âŒ firebase.json has invalid JSON syntax"
            exit 1
          }
          
          python -m json.tool config/environments.json > /dev/null || {
            echo "âŒ config/environments.json has invalid JSON syntax"
            exit 1
          }
          
          echo "âœ… All configuration files are valid"
      
      # âœ… SIMPLIFICATION: Configuration dynamique via script
      - name: âš™ï¸ Setup Firebase Configuration
        env:
          FIREBASE_PROJECT: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
        run: |
          echo "ğŸ”§ Setting up Firebase configuration for: $FIREBASE_PROJECT"
          
          # ExÃ©cution du script de configuration
          node scripts/setup-firebase.js
          
          # VÃ©rification des fichiers gÃ©nÃ©rÃ©s
          echo "ğŸ“‹ Generated files:"
          ls -la .firebaserc public/index.html .env.firebase 2>/dev/null || echo "Some files not generated"
          
          # Affichage de la configuration (sans secrets)
          echo "ğŸ¯ Target project: $(cat .firebaserc | grep -o '"default":"[^"]*"' | cut -d'"' -f4)"
      
      # âœ… SIMPLIFICATION: DÃ©ploiement avec gestion d'environnement
      - name: ğŸš€ Deploy to Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
          FIREBASE_SERVICE_ACCOUNT_PROD: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_PROD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          IS_PRODUCTION: ${{ github.ref == 'refs/heads/main' }}
        run: |
          # SÃ©lection du service account selon l'environnement
          if [ "$IS_PRODUCTION" = "true" ]; then
            echo "ğŸ­ Production deployment"
            PROJECT="taxasge-prod"
            SERVICE_ACCOUNT="$FIREBASE_SERVICE_ACCOUNT_PROD"
          else
            echo "ğŸ§ª Development deployment"
            PROJECT="taxasge-dev"
            SERVICE_ACCOUNT="$FIREBASE_SERVICE_ACCOUNT"
          fi
          
          # VÃ©rification du service account
          if [ -z "$SERVICE_ACCOUNT" ]; then
            echo "âŒ Firebase service account not configured for $PROJECT"
            echo "Please add the appropriate secret in GitHub repository settings"
            exit 1
          fi
          
          # Configuration des credentials Firebase
          echo "ğŸ” Setting up Firebase credentials..."
          echo "$SERVICE_ACCOUNT" > /tmp/firebase-sa.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/firebase-sa.json"
          
          # Configuration des variables d'environnement pour Firebase Functions
          echo "âš™ï¸ Setting up Functions environment variables..."
          firebase functions:config:set \
            database.url="$DATABASE_URL" \
            supabase.url="$SUPABASE_URL" \
            supabase.service_role_key="$SUPABASE_SERVICE_ROLE_KEY" \
            app.environment="$PROJECT" \
            --project "$PROJECT" || echo "Config may already be set"
          
          # DÃ©ploiement
          echo "ğŸš€ Deploying to Firebase project: $PROJECT"
          firebase deploy \
            --only functions,hosting \
            --project "$PROJECT" \
            --non-interactive \
            --force
          
          # Nettoyage sÃ©curisÃ©
          rm -f /tmp/firebase-sa.json
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ URL: https://$PROJECT.web.app"
      
      # âœ… SIMPLIFICATION: Health check avec retry
      - name: ğŸ§ª Post-Deployment Health Check
        run: |
          # DÃ©termination de l'URL selon la branch
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            BASE_URL="https://taxasge-prod.web.app"
          else
            BASE_URL="https://taxasge-dev.web.app"
          fi
          
          echo "ğŸ” Testing deployed API at: $BASE_URL"
          echo "â³ Waiting for deployment to be ready..."
          sleep 30
          
          # Fonction de test avec retry
          test_endpoint() {
            local endpoint=$1
            local description=$2
            
            echo "Testing $description..."
            for i in {1..3}; do
              if curl -f "$BASE_URL$endpoint" -m 10 --silent > /dev/null; then
                echo "âœ… $description: OK"
                return 0
              else
                echo "âš ï¸ $description: Failed (attempt $i/3)"
                [ $i -lt 3 ] && sleep 10
              fi
            done
            echo "âŒ $description: Failed after 3 attempts"
            return 1
          }
          
          # Tests des endpoints
          test_endpoint "/api/main" "Main API endpoint"
          test_endpoint "/api/health" "Health check endpoint"
          test_endpoint "/api/taxes" "Taxes endpoint"
          test_endpoint "/" "Hosting page"
          
          echo ""
          echo "ğŸ‰ Health check completed!"
          echo "ğŸ”— Application URL: $BASE_URL"
          echo "ğŸ”— API Documentation: $BASE_URL/docs"
          
          # Affichage des liens utiles
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ğŸ”— Firebase Console: https://console.firebase.google.com/project/taxasge-prod"
          else
            echo "ğŸ”— Firebase Console: https://console.firebase.google.com/project/taxasge-dev"
          fi
