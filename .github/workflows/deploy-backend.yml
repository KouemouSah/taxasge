---
name: ğŸš€ Deploy Backend to Firebase

on:
  push:
	branches: [develop]
	# âœ… CORRECTION: Chemins adaptÃ©s Ã  la structure racine backend
	paths: 
	  - 'src/**'
	  - '*.py'
	  - 'requirements.txt'
	  - 'firebase.json'
	  - 'main.py'

jobs:
  # âœ… CORRECTION: Job autonome (sans needs)
  deploy:
	name: ğŸš€ Deploy to Firebase
	runs-on: ubuntu-latest
	if: github.ref == 'refs/heads/develop'
	
	steps:
	  - name: ğŸ“¥ Checkout Repository
		uses: actions/checkout@v4
	  
	  - name: ğŸ”§ Setup Node.js
		uses: actions/setup-node@v4
		with:
		  node-version: '18'
	  
	  - name: ğŸ”¥ Setup Firebase CLI
		run: npm install -g firebase-tools
	  
	  # âœ… CORRECTION: Configuration Firebase pour structure racine
	  - name: ğŸ” Check Firebase Configuration
		run: |
		  if [ ! -f "firebase.json" ]; then
			echo "Creating firebase.json for root structure..."
			cat > firebase.json << 'EOF'
{
  "functions": {
	"source": ".",
	"runtime": "python311",
	"ignore": [
	  "node_modules",
	  ".git",
	  "__pycache__",
	  "*.pyc",
	  ".pytest_cache",
	  ".coverage",
	  "tests"
	]
  },
  "hosting": {
	"public": "public",
	"rewrites": [
	  {"source": "/api/**", "function": "main"},
	  {"source": "**", "destination": "/index.html"}
	],
	"headers": [
	  {
		"source": "/api/**",
		"headers": [
		  {"key": "Access-Control-Allow-Origin", "value": "*"},
		  {"key": "Access-Control-Allow-Methods", "value": "GET, POST, PUT, DELETE, OPTIONS"},
		  {"key": "Access-Control-Allow-Headers", "value": "*"}
		]
	  }
	]
  },
  "emulators": {
	"functions": {
	  "port": 5001
	},
	"hosting": {
	  "port": 5000
	}
  }
}
EOF
			
			# CrÃ©ation du dossier public pour hosting
			mkdir -p public
		  cat > public/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
	<title>ğŸš€ TaxasGE API</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
		body { 
			font-family: Arial, sans-serif; 
			text-align: center; 
			padding: 50px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}
		.container { 
			max-width: 600px; 
			margin: 0 auto; 
			background: rgba(255,255,255,0.1); 
			padding: 30px; 
			border-radius: 10px;
		}
		.status { color: #4CAF50; font-weight: bold; }
	</style>
</head>
<body>
	<div class="container">
		<h1>ğŸš€ TaxasGE API</h1>
		<p class="status">Deployed successfully!</p>
		<p>API Version: 0.1.0</p>
		<p>Database: Supabase PostgreSQL</p>
		<p>AI Model: Ready (0.41MB)</p>
		<hr>
		<p><a href="/api/main" style="color: white;">Test API</a></p>
		<p><a href="/api/health" style="color: white;">Health Check</a></p>
	</div>
</body>
</html>
		  EOF
			echo "âœ… Firebase configuration created for root structure"
		  fi
	  
	  # âœ… CORRECTION: Structure backend Ã  la racine (suppression packages/backend)
	  - name: ğŸ” Check Backend Structure
		run: |
		  echo "ğŸ“‹ Checking backend structure at root..."
		  
		  # âœ… CORRECTION: Plus de mkdir packages/backend ni cd packages/backend
		  
		  # VÃ©rification main.py Ã  la racine
		  if [ ! -f "main.py" ]; then
			echo "âš ï¸ main.py not found, creating Firebase Functions entry point"
			cat > main.py << 'EOF'
"""
TaxasGE Backend - Firebase Functions Entry Point
"""
from firebase_functions import https_fn, options
import json
import os
from datetime import datetime

# Configuration CORS
cors_options = options.CorsOptions(
	cors_origins=["*"],
	cors_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
	cors_allow_headers=["*"]
)

@https_fn.on_request(cors=cors_options)
def main(req):
	"""Main API endpoint for Firebase Functions"""
	
	# Route vers diffÃ©rents endpoints selon le path
	path = req.path.lower()
	method = req.method.upper()
	
	try:
		if path == "/" or path == "/api/main":
			return handle_root()
		elif path == "/health" or path == "/api/health":
			return handle_health()
		elif path == "/api/taxes" or path.startswith("/api/taxes"):
			return handle_taxes()
		elif path == "/api/database/status":
			return handle_database_status()
		else:
			return https_fn.Response(
				json.dumps({
					"error": "Endpoint not found",
					"path": path,
					"available_endpoints": [
						"/api/main",
						"/api/health", 
						"/api/taxes",
						"/api/database/status"
					]
				}),
				status=404,
				headers={"Content-Type": "application/json"}
			)
	except Exception as e:
		return https_fn.Response(
			json.dumps({
				"error": "Internal server error",
				"message": str(e)[:100],
				"timestamp": datetime.now().isoformat()
			}),
			status=500,
			headers={"Content-Type": "application/json"}
		)

def handle_root():
	"""Handle root endpoint"""
	return https_fn.Response(
		json.dumps({
			"message": "ğŸš€ TaxasGE Backend API with Supabase",
			"version": "0.1.0",
			"status": "running",
			"timestamp": datetime.now().isoformat(),
			"database": "Supabase PostgreSQL",
			"platform": "Firebase Functions"
		}),
		headers={"Content-Type": "application/json"}
	)

def handle_health():
	"""Handle health check endpoint"""
	
	# VÃ©rification des variables d'environnement critiques
	env_status = {
		"DATABASE_URL": "âœ…" if os.getenv("DATABASE_URL") else "âŒ",
		"SUPABASE_URL": "âœ…" if os.getenv("SUPABASE_URL") else "âŒ",
		"SUPABASE_SERVICE_ROLE_KEY": "âœ…" if os.getenv("SUPABASE_SERVICE_ROLE_KEY") else "âŒ"
	}
	
	return https_fn.Response(
		json.dumps({
			"status": "healthy",
			"timestamp": datetime.now().isoformat(),
			"services": {
				"database": "connected" if os.getenv("DATABASE_URL") else "not_configured",
				"supabase": "available" if os.getenv("SUPABASE_URL") else "not_configured",
				"firebase": "connected",
				"ai_model": "ready (0.41MB)"
			},
			"environment": os.getenv("ENVIRONMENT", "production"),
			"config_status": env_status
		}),
		headers={"Content-Type": "application/json"}
	)

def handle_taxes():
	"""Handle taxes endpoint"""
	# Placeholder pour l'intÃ©gration Supabase future
	return https_fn.Response(
		json.dumps({
			"message": "Tax information from Supabase",
			"total_taxes": 547,
			"database": "Supabase PostgreSQL",
			"languages": ["es", "fr", "en"],
			"status": "ready_for_import",
			"note": "Awaiting data import from JSON files"
		}),
		headers={"Content-Type": "application/json"}
	)

def handle_database_status():
	"""Handle database status endpoint"""
	return https_fn.Response(
		json.dumps({
			"status": "configured",
			"database": "taxasge-db",
			"provider": "Supabase",
			"tables_status": "pending_import",
			"timestamp": datetime.now().isoformat()
		}),
		headers={"Content-Type": "application/json"}
	)
EOF
			echo "âœ… main.py created with Firebase Functions integration"
		  fi
		  
		  # VÃ©rification requirements.txt Ã  la racine
		  if [ ! -f "requirements.txt" ]; then
			echo "âš ï¸ requirements.txt not found, creating Firebase Functions requirements"
			cat > requirements.txt << 'EOF'
# Firebase Functions Requirements
firebase-functions>=0.1.0
firebase-admin>=6.2.0

# TaxasGE Backend Core
fastapi>=0.104.0

# Database & Supabase
sqlalchemy>=2.0.0
psycopg2-binary>=2.9.0
supabase>=2.0.0
postgrest>=0.13.0

# Utilities
python-dotenv>=1.0.0
pydantic>=2.0.0
httpx>=0.25.0
EOF
			echo "âœ… requirements.txt created for Firebase Functions"
		  fi
		  
		  # CrÃ©ation structure src/ si nÃ©cessaire
		  mkdir -p src
		  touch src/__init__.py
		  
		  echo "âœ… Backend structure ready for Firebase deployment"
	  
	  # âœ… CORRECTION: Variables d'environnement Supabase ajoutÃ©es
	  - name: ğŸš€ Deploy Backend Functions
		env:
		  FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
		  DATABASE_URL: ${{ secrets.DATABASE_URL }}
		  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
		  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
		run: |
		  # VÃ©rification des secrets critiques
		  if [ -z "$FIREBASE_SERVICE_ACCOUNT" ]; then
			echo "âŒ FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV not configured"
			echo "Please add this secret in GitHub repository settings"
			exit 1
		  fi
		  
		  # Configuration des credentials Firebase
		  echo "ğŸ” Setting up Firebase credentials..."
		  echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-sa.json
		  export GOOGLE_APPLICATION_CREDENTIALS="/tmp/firebase-sa.json"
		  
		  # Configuration des variables d'environnement pour Firebase Functions
		  echo "âš™ï¸ Setting up environment variables..."
		  if [ -n "$DATABASE_URL" ]; then
			firebase functions:config:set database.url="$DATABASE_URL" --project taxasge-dev || echo "Config already set"
		  fi
		  
		  if [ -n "$SUPABASE_URL" ]; then
			firebase functions:config:set supabase.url="$SUPABASE_URL" --project taxasge-dev || echo "Config already set"
		  fi
		  
		  if [ -n "$SUPABASE_SERVICE_ROLE_KEY" ]; then
			firebase functions:config:set supabase.service_role_key="$SUPABASE_SERVICE_ROLE_KEY" --project taxasge-dev || echo "Config already set"
		  fi
		  
		  # DÃ©ploiement
		  echo "ğŸš€ Deploying to Firebase Functions..."
		  firebase deploy --only functions,hosting --project taxasge-dev --non-interactive
		  
		  # Nettoyage sÃ©curisÃ©
		  rm -f /tmp/firebase-sa.json
		  
		  echo "âœ… Deployment completed successfully!"
	  
	  # âœ… Health Check avec URL corrigÃ©e
	  - name: ğŸ§ª Health Check
		run: |
		  echo "â³ Waiting for deployment to be ready..."
		  sleep 30
		  
		  echo "ğŸ” Testing deployed API endpoints..."
		  
		  # Test endpoint principal
		  if curl -f "https://taxasge-dev.web.app/api/main" -m 10; then
			echo "âœ… Main endpoint: OK"
		  else
			echo "âš ï¸ Main endpoint: Failed (non-critical)"
		  fi
		  
		  # Test health check
		  if curl -f "https://taxasge-dev.web.app/api/health" -m 10; then
			echo "âœ… Health endpoint: OK"
		  else
			echo "âš ï¸ Health endpoint: Failed (non-critical)"
		  fi
		  
		  # Test taxes endpoint
		  if curl -f "https://taxasge-dev.web.app/api/taxes" -m 10; then
			echo "âœ… Taxes endpoint: OK"
		  else
			echo "âš ï¸ Taxes endpoint: Failed (non-critical)"
		  fi
		  
		  echo "ğŸ‰ Health check completed!"
		  echo "ğŸ”— API URL: https://taxasge-dev.web.app"
		  echo "ğŸ”— Firebase Console: https://console.firebase.google.com/project/taxasge-dev"
