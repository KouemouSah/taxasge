---
name: ğŸš€ Deploy Backend to Firebase

on:
  push:
    branches: [develop, main]
    paths: 
      - 'src/**'
      - '*.py'
      - 'requirements.txt'
      - 'firebase.json'
      - 'main.py'
      - 'config/**'
      - 'scripts/**'

jobs:
  deploy:
    name: ğŸš€ Deploy to Firebase
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          # Node.js dependencies for Firebase CLI
          npm install -g firebase-tools
          
          # Python dependencies
          pip install -r requirements.txt
          echo "âœ… Dependencies installed"
      
      - name: ğŸ” Debug - Validate Configuration Files
        run: |
          echo "ğŸ” Validating configuration files..."
          
          # Liste des fichiers requis
          echo "ğŸ“‹ Checking required files:"
          for file in "firebase.json" "config/environments.json" "scripts/setup-firebase.js" "requirements.txt" "main.py"; do
            if [ -f "$file" ]; then
              echo "âœ… $file found"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done
          
          # Validation JSON syntax
          echo "ğŸ” Validating JSON files..."
          python -m json.tool firebase.json > /dev/null || {
            echo "âŒ firebase.json has invalid JSON syntax"
            exit 1
          }
          
          python -m json.tool config/environments.json > /dev/null || {
            echo "âŒ config/environments.json has invalid JSON syntax"
            exit 1
          }
          
          echo "âœ… All configuration files are valid"
      
      - name: âš™ï¸ Setup Firebase Configuration
        env:
          FIREBASE_PROJECT: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
        run: |
          echo "ğŸ”§ Setting up Firebase configuration for: $FIREBASE_PROJECT"
          
          # ExÃ©cution du script de configuration
          node scripts/setup-firebase.js
          
          # Debug: Affichage des fichiers gÃ©nÃ©rÃ©s
          echo "ğŸ“‹ Generated files:"
          if [ -f ".firebaserc" ]; then
            echo "âœ… .firebaserc created"
            echo "ğŸ” Content preview:"
            head -5 .firebaserc
          else
            echo "âŒ .firebaserc not created"
            exit 1
          fi
          
          if [ -f "public/index.html" ]; then
            echo "âœ… public/index.html created"
          else
            echo "âŒ public/index.html not created"
            exit 1
          fi
          
          # Affichage de la configuration (sans secrets)
          echo "ğŸ¯ Target project: $(cat .firebaserc | grep -o '"default":"[^"]*"' | cut -d'"' -f4 || echo 'unknown')"
      
      - name: ğŸ Setup Backend Configuration
        env:
          ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'firebase_prod' || 'firebase_dev' }}
        run: |
          echo "ğŸ”§ Setting up backend configuration for: $ENVIRONMENT"
          
          # ExÃ©cution du script de configuration backend
          python scripts/setup-backend.py
          
          # VÃ©rification des fichiers gÃ©nÃ©rÃ©s
          echo "ğŸ“‹ Backend files generated:"
          if [ -f "main.py" ]; then
            echo "âœ… main.py exists"
            echo "ğŸ” main.py preview (first 10 lines):"
            head -10 main.py
          else
            echo "âŒ main.py not found"
            exit 1
          fi
          
          if [ -f ".env.backend.json" ]; then
            echo "âœ… .env.backend.json created"
          fi
      
      - name: ğŸ” Debug - Environment and Secrets
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
          FIREBASE_SERVICE_ACCOUNT_PROD: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_PROD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          IS_PRODUCTION: ${{ github.ref == 'refs/heads/main' }}
        run: |
          echo "ğŸ” Debug: Environment and secrets check..."
          
          # DÃ©termination de l'environnement
          if [ "$IS_PRODUCTION" = "true" ]; then
            echo "ğŸ­ Production deployment detected"
            PROJECT="taxasge-prod"
            SERVICE_ACCOUNT="$FIREBASE_SERVICE_ACCOUNT_PROD"
          else
            echo "ğŸ§ª Development deployment detected"
            PROJECT="taxasge-dev"
            SERVICE_ACCOUNT="$FIREBASE_SERVICE_ACCOUNT"
          fi
          
          # VÃ©rification des secrets (sans exposer les valeurs)
          echo "ğŸ” Secrets verification:"
          if [ -n "$SERVICE_ACCOUNT" ]; then
            echo "âœ… Firebase service account configured (${#SERVICE_ACCOUNT} chars)"
          else
            echo "âŒ Firebase service account missing for $PROJECT"
            echo "Required secret: FIREBASE_SERVICE_ACCOUNT_TAXASGE_$([ "$IS_PRODUCTION" = "true" ] && echo "PROD" || echo "DEV")"
            exit 1
          fi
          
          if [ -n "$DATABASE_URL" ]; then
            echo "âœ… DATABASE_URL configured (${#DATABASE_URL} chars)"
          else
            echo "âš ï¸ DATABASE_URL not configured"
          fi
          
          if [ -n "$SUPABASE_URL" ]; then
            echo "âœ… SUPABASE_URL configured (${#SUPABASE_URL} chars)"
          else
            echo "âš ï¸ SUPABASE_URL not configured"
          fi
          
          if [ -n "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "âœ… SUPABASE_SERVICE_ROLE_KEY configured (${#SUPABASE_SERVICE_ROLE_KEY} chars)"
          else
            echo "âš ï¸ SUPABASE_SERVICE_ROLE_KEY not configured"
          fi
          
          echo "ğŸ¯ Target project: $PROJECT"
      
      - name: ğŸš€ Deploy to Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
          FIREBASE_SERVICE_ACCOUNT_PROD: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_PROD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          IS_PRODUCTION: ${{ github.ref == 'refs/heads/main' }}
        run: |
          # SÃ©lection du service account selon l'environnement
          if [ "$IS_PRODUCTION" = "true" ]; then
            echo "ğŸ­ Production deployment"
            PROJECT="taxasge-prod"
            SERVICE_ACCOUNT="$FIREBASE_SERVICE_ACCOUNT_PROD"
          else
            echo "ğŸ§ª Development deployment"
            PROJECT="taxasge-dev"
            SERVICE_ACCOUNT="$FIREBASE_SERVICE_ACCOUNT"
          fi
          
          # Configuration des credentials Firebase
          echo "ğŸ” Setting up Firebase credentials..."
          echo "$SERVICE_ACCOUNT" > /tmp/firebase-sa.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/firebase-sa.json"
          
          # Debug: VÃ©rification de la structure du projet
          echo "ğŸ” Project structure verification:"
          echo "ğŸ“ Current directory contents:"
          ls -la
          echo "ğŸ“ Firebase configuration:"
          cat firebase.json | head -20
          echo "ğŸ“ Main.py exists: $([ -f "main.py" ] && echo "YES" || echo "NO")"
          echo "ğŸ“ Requirements.txt exists: $([ -f "requirements.txt" ] && echo "YES" || echo "NO")"
          
          # Test Firebase CLI
          echo "ğŸ”¥ Testing Firebase CLI..."
          firebase --version
          
          # Configuration des variables d'environnement pour Firebase Functions
          echo "âš™ï¸ Setting up Functions environment variables..."
          firebase functions:config:set \
            database.url="$DATABASE_URL" \
            supabase.url="$SUPABASE_URL" \
            supabase.service_role_key="$SUPABASE_SERVICE_ROLE_KEY" \
            app.environment="$PROJECT" \
            --project "$PROJECT" || echo "âš ï¸ Config may already be set"
          
          # DÃ©ploiement avec debugging Ã©tendu
          echo "ğŸš€ Deploying to Firebase project: $PROJECT"
          echo "ğŸ“‹ Deployment command: firebase deploy --only functions,hosting --project $PROJECT --non-interactive"
          
          firebase deploy \
            --only functions,hosting \
            --project "$PROJECT" \
            --non-interactive \
            --debug
          
          # Nettoyage sÃ©curisÃ©
          rm -f /tmp/firebase-sa.json
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ URL: https://$PROJECT.web.app"
      
      - name: ğŸ§ª Post-Deployment Health Check
        run: |
          # DÃ©termination de l'URL selon la branch
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            BASE_URL="https://taxasge-prod.web.app"
            ENV_NAME="Production"
          else
            BASE_URL="https://taxasge-dev.web.app"
            ENV_NAME="Development"
          fi
          
          echo "ğŸ” Testing deployed API at: $BASE_URL ($ENV_NAME)"
          echo "â³ Waiting for deployment to be ready..."
          sleep 45  # AugmentÃ© pour Firebase Functions cold start
          
          # Fonction de test avec retry amÃ©liorÃ©
          test_endpoint() {
            local endpoint=$1
            local description=$2
            
            echo "ğŸ§ª Testing $description ($endpoint)..."
            for i in {1..5}; do  # AugmentÃ© Ã  5 tentatives
              if curl -f "$BASE_URL$endpoint" -m 15 --silent --show-error > /tmp/response.txt 2>/dev/null; then
                echo "âœ… $description: OK"
                if [ "$endpoint" = "/" ] || [ "$endpoint" = "/api/main" ]; then
                  echo "ğŸ“„ Response preview:"
                  head -3 /tmp/response.txt
                fi
                return 0
              else
                echo "âš ï¸ $description: Failed (attempt $i/5)"
                if [ $i -lt 5 ]; then
                  echo "   â³ Waiting 10s before retry..."
                  sleep 10
                fi
              fi
            done
            echo "âŒ $description: Failed after 5 attempts"
            return 1
          }
          
          # Tests des endpoints avec retry
          success_count=0
          total_tests=4
          
          if test_endpoint "/" "Hosting page"; then ((success_count++)); fi
          if test_endpoint "/api/main" "Main API endpoint"; then ((success_count++)); fi
          if test_endpoint "/health" "Health check endpoint"; then ((success_count++)); fi
          if test_endpoint "/api/taxes" "Taxes endpoint"; then ((success_count++)); fi
          
          # RÃ©sumÃ© des rÃ©sultats
          echo ""
          echo "ğŸ“Š Health Check Results: $success_count/$total_tests endpoints successful"
          
          if [ $success_count -eq $total_tests ]; then
            echo "ğŸ‰ All health checks passed!"
          elif [ $success_count -gt 0 ]; then
            echo "âš ï¸ Partial success - some endpoints working"
          else
            echo "âŒ All health checks failed"
            echo "ğŸ” This might be normal for Firebase Functions cold start"
            echo "ğŸ’¡ Try accessing $BASE_URL manually in a few minutes"
          fi
          
          echo ""
          echo "ğŸ”— Application URL: $BASE_URL"
          echo "ğŸ”— API Documentation: $BASE_URL/docs"
          
          # Affichage des liens utiles
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ğŸ”— Firebase Console: https://console.firebase.google.com/project/taxasge-prod"
          else
            echo "ğŸ”— Firebase Console: https://console.firebase.google.com/project/taxasge-dev"
          fi
          
          # Cleanup
          rm -f /tmp/response.txt
