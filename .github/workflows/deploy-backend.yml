# ============================================================================
# 2. CORRECTION deploy-backend.yml - Structure job corrigÃ©e
# ============================================================================

---
name: Deploy Backend to Firebase

on:
  push:
    branches: [develop]
    paths: ['packages/backend/**']

jobs:
  # âœ… CORRECTION: Job autonome (sans needs)
  deploy:
    name: ðŸš€ Deploy to Firebase
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ”¥ Setup Firebase CLI
        run: npm install -g firebase-tools
      
      - name: ðŸ” Check Firebase Configuration
        run: |
          if [ ! -f "firebase.json" ]; then
            echo "Creating firebase.json..."
            cat > firebase.json << 'EOF'
          {
            "functions": {
              "source": "packages/backend",
              "runtime": "python311"
            },
            "hosting": {
              "public": "public",
              "rewrites": [
                {"source": "/api/**", "function": "main"},
                {"source": "**", "destination": "/index.html"}
              ]
            }
          }
          EOF
            
            mkdir -p public
            echo '<h1>ðŸš€ TaxasGE API</h1><p>Deployed successfully!</p>' > public/index.html
          fi
      
      - name: ðŸ” Check Backend Structure
        run: |
          mkdir -p packages/backend
          cd packages/backend
          
          if [ ! -f "main.py" ]; then
            cat > main.py << 'EOF'
          from firebase_functions import https_fn
          import json

          @https_fn.on_request()
          def main(req):
              return https_fn.Response(
                  json.dumps({"message": "TaxasGE API", "status": "running"}),
                  headers={"Content-Type": "application/json"}
              )
          EOF
          fi
          
          if [ ! -f "requirements.txt" ]; then
            echo "firebase-functions>=0.1.0" > requirements.txt
          fi
      
      # âœ… CORRECTION: Variables d'environnement Supabase ajoutÃ©es
      - name: ðŸš€ Deploy Backend Functions
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -z "$FIREBASE_SERVICE_ACCOUNT" ]; then
            echo "âŒ FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV not configured"
            exit 1
          fi
          
          echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-sa.json
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/firebase-sa.json"
          
          firebase deploy --only functions --project taxasge-dev --non-interactive
          
          rm -f /tmp/firebase-sa.json
      
      - name: ðŸ§ª Health Check
        run: |
          sleep 30
          curl -f "https://taxasge-dev.web.app/api/main" || echo "Health check failed (non-critical)"
