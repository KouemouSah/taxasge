# ============================================================================
# ğŸ“Š TaxasGE Status Dashboard - Project Monitoring
# ============================================================================
# Workflow de monitoring et dashboard de statut du projet TaxasGE
# Collecte et publie les mÃ©triques de santÃ© de l'infrastructure
#
# Features:
# - Monitoring santÃ© des services (Backend API, Mobile, Database)
# - MÃ©triques de performance et disponibilitÃ©
# - Status badges automatiques pour le README
# - Alertes proactives sur les problÃ¨mes
# - Dashboard temps rÃ©el avec historique
# - IntÃ©gration Slack/Discord pour notifications
#
# Author: KOUEMOU SAH Jean Emac
# ============================================================================

name: ğŸ“Š Status Dashboard

on:
  # Monitoring pÃ©riodique
  schedule:
    - cron: '*/15 * * * *' # Toutes les 15 minutes
    - cron: '0 */1 * * *'  # Toutes les heures (mÃ©triques dÃ©taillÃ©es)
    - cron: '0 0 * * *'    # Quotidien (rapport complet)
  
  # Monitoring sur Ã©vÃ©nements importants
  workflow_run:
    workflows: ["ğŸš€ Deploy Backend to Firebase", "ğŸ“± Mobile CI (React Native)", "ğŸ Backend CI/CD"]
    types: [completed]
  
  # Monitoring manuel
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type de vÃ©rification'
        required: true
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - deep
      notify_team:
        description: 'Notifier l''Ã©quipe'
        required: false
        default: true
        type: boolean

# ============================================================================
# VARIABLES GLOBALES
# ============================================================================

env:
  FIREBASE_PROJECT_DEV: 'taxasge-dev'
  FIREBASE_PROJECT_PROD: 'taxasge-prod'
  API_TIMEOUT: '30'
  MAX_RETRIES: '3'

# ============================================================================
# JOBS DE MONITORING
# ============================================================================

jobs:
  # ==========================================================================
  # JOB 1: MONITORING SERVICES CORE
  # ==========================================================================
  
  monitor-services:
    name: ğŸ” Monitor Core Services
    runs-on: ubuntu-latest
    
    outputs:
      backend-status: ${{ steps.backend.outputs.status }}
      database-status: ${{ steps.database.outputs.status }}
      firebase-status: ${{ steps.firebase.outputs.status }}
      overall-health: ${{ steps.summary.outputs.health }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup monitoring environment
        run: |
          echo "ğŸ”§ Configuration monitoring TaxasGE"
          echo "ğŸ“… Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸ¯ Check type: ${{ github.event.inputs.check_type || 'scheduled' }}"
          
          # Installation outils monitoring
          curl -s -o /dev/null -w "curl_version: %{version}\n" https://httpbin.org/get > /dev/null

      - name: ğŸš€ Monitor Backend API
        id: backend
        run: |
          echo "ğŸš€ VÃ©rification Backend API TaxasGE"
          
          # URLs Ã  tester selon environnement
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            API_BASE="https://taxasge-prod.web.app"
          else
            API_BASE="https://taxasge-dev.web.app"
          fi
          
          # Test endpoints critiques
          declare -A endpoints=(
            ["root"]="/"
            ["health"]="/health"
            ["api-v1"]="/api/v1/"
            ["docs"]="/docs"
          )
          
          success_count=0
          total_count=${#endpoints[@]}
          response_times=""
          
          for endpoint in "${!endpoints[@]}"; do
            url="$API_BASE${endpoints[$endpoint]}"
            echo "ğŸ” Test $endpoint: $url"
            
            # Mesurer temps de rÃ©ponse
            start_time=$(date +%s%N)
            if response=$(curl -s -w "%{http_code}|%{time_total}" -m ${{ env.API_TIMEOUT }} "$url" 2>/dev/null); then
              end_time=$(date +%s%N)
              
              http_code=$(echo "$response" | tail -c 12 | cut -d'|' -f1)
              response_time=$(echo "$response" | tail -c 12 | cut -d'|' -f2)
              
              if [[ "$http_code" =~ ^(200|201|302)$ ]]; then
                echo "âœ… $endpoint: OK (${response_time}s)"
                ((success_count++))
                response_times="$response_times$endpoint:${response_time}s "
              else
                echo "âš ï¸ $endpoint: HTTP $http_code"
              fi
            else
              echo "âŒ $endpoint: Timeout/Error"
            fi
          done
          
          # Calcul status global backend
          if [[ $success_count -eq $total_count ]]; then
            backend_status="operational"
            echo "âœ… Backend API: Tous services opÃ©rationnels ($success_count/$total_count)"
          elif [[ $success_count -gt 0 ]]; then
            backend_status="degraded"
            echo "âš ï¸ Backend API: Performance dÃ©gradÃ©e ($success_count/$total_count)"
          else
            backend_status="down"
            echo "âŒ Backend API: Services indisponibles"
          fi
          
          echo "status=$backend_status" >> $GITHUB_OUTPUT
          echo "success_rate=$((success_count * 100 / total_count))" >> $GITHUB_OUTPUT
          echo "response_times=$response_times" >> $GITHUB_OUTPUT

      - name: ğŸ—„ï¸ Monitor Database Status
        id: database
        run: |
          echo "ğŸ—„ï¸ VÃ©rification Supabase Database"
          
          # Test connexion Supabase via API REST
          SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          SUPABASE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          
          if [[ -n "$SUPABASE_URL" && -n "$SUPABASE_KEY" ]]; then
            # Test basique de connexion
            if curl -s -H "apikey: $SUPABASE_KEY" -H "Authorization: Bearer $SUPABASE_KEY" \
                -m 10 "$SUPABASE_URL/rest/v1/" > /dev/null; then
              echo "âœ… Supabase: Connexion OK"
              
              # Test requÃªte simple (si tables existent)
              if curl -s -H "apikey: $SUPABASE_KEY" -H "Authorization: Bearer $SUPABASE_KEY" \
                  -m 10 "$SUPABASE_URL/rest/v1/taxes?limit=1" > /dev/null 2>&1; then
                database_status="operational"
                echo "âœ… Database: Tables accessibles"
              else
                database_status="partial"
                echo "âš ï¸ Database: Connexion OK, tables en cours d'initialisation"
              fi
            else
              database_status="down"
              echo "âŒ Supabase: Connexion Ã©chouÃ©e"
            fi
          else
            database_status="unknown"
            echo "âš ï¸ Database: Secrets Supabase non configurÃ©s"
          fi
          
          echo "status=$database_status" >> $GITHUB_OUTPUT

      - name: ğŸ”¥ Monitor Firebase Services
        id: firebase
        run: |
          echo "ğŸ”¥ VÃ©rification Firebase Services"
          
          # Test Firebase Functions (via HTTP)
          firebase_status="unknown"
          
          # Test connexion Firebase Hosting
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            FIREBASE_URL="https://taxasge-prod.web.app"
          else
            FIREBASE_URL="https://taxasge-dev.web.app"
          fi
          
          if curl -s -m 10 "$FIREBASE_URL" > /dev/null; then
            echo "âœ… Firebase Hosting: Accessible"
            firebase_status="operational"
          else
            echo "âŒ Firebase Hosting: Inaccessible"
            firebase_status="down"
          fi
          
          # Test Firebase Functions (si dÃ©ployÃ©es)
          if curl -s -m 15 "$FIREBASE_URL/api/" > /dev/null 2>&1; then
            echo "âœ… Firebase Functions: OpÃ©rationnelles"
          else
            echo "âš ï¸ Firebase Functions: Non dÃ©ployÃ©es ou inaccessibles"
            if [[ "$firebase_status" == "operational" ]]; then
              firebase_status="partial"
            fi
          fi
          
          echo "status=$firebase_status" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Calculate Overall Health
        id: summary
        run: |
          backend="${{ steps.backend.outputs.status }}"
          database="${{ steps.database.outputs.status }}"
          firebase="${{ steps.firebase.outputs.status }}"
          
          echo "ğŸ“Š Status Summary:"
          echo "Backend: $backend"
          echo "Database: $database"
          echo "Firebase: $firebase"
          
          # Calcul santÃ© globale
          if [[ "$backend" == "operational" && "$database" == "operational" && "$firebase" == "operational" ]]; then
            overall_health="healthy"
            health_emoji="âœ…"
            health_color="green"
          elif [[ "$backend" == "down" || "$database" == "down" || "$firebase" == "down" ]]; then
            overall_health="critical"
            health_emoji="âŒ"
            health_color="red"
          else
            overall_health="degraded"
            health_emoji="âš ï¸"
            health_color="yellow"
          fi
          
          echo "health=$overall_health" >> $GITHUB_OUTPUT
          echo "emoji=$health_emoji" >> $GITHUB_OUTPUT
          echo "color=$health_color" >> $GITHUB_OUTPUT
          
          echo "$health_emoji TaxasGE Global Health: $overall_health"

  # ==========================================================================
  # JOB 2: MÃ‰TRIQUES DE PERFORMANCE
  # ==========================================================================
  
  collect-metrics:
    name: ğŸ“ˆ Collect Performance Metrics
    runs-on: ubuntu-latest
    needs: monitor-services
    if: github.event.inputs.check_type != 'quick'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“ˆ Collect GitHub Metrics
        id: github-metrics
        run: |
          echo "ğŸ“ˆ Collection mÃ©triques GitHub"
          
          # API GitHub pour statistiques repository
          REPO_API="https://api.github.com/repos/${{ github.repository }}"
          
          # MÃ©triques repository
          if repo_data=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$REPO_API"); then
            stars=$(echo "$repo_data" | jq -r '.stargazers_count // 0')
            forks=$(echo "$repo_data" | jq -r '.forks_count // 0')
            issues=$(echo "$repo_data" | jq -r '.open_issues_count // 0')
            size=$(echo "$repo_data" | jq -r '.size // 0')
            
            echo "â­ Stars: $stars"
            echo "ğŸ´ Forks: $forks"
            echo "ğŸ› Open Issues: $issues"
            echo "ğŸ“¦ Size: ${size}KB"
            
            echo "stars=$stars" >> $GITHUB_OUTPUT
            echo "forks=$forks" >> $GITHUB_OUTPUT
            echo "issues=$issues" >> $GITHUB_OUTPUT
            echo "size=$size" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Impossible de rÃ©cupÃ©rer les mÃ©triques GitHub"
          fi

      - name: ğŸ“Š Collect Workflow Metrics
        run: |
          echo "ğŸ“Š MÃ©triques workflows rÃ©cents"
          
          # DerniÃ¨res exÃ©cutions workflows
          WORKFLOWS_API="https://api.github.com/repos/${{ github.repository }}/actions/runs"
          
          if workflow_data=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$WORKFLOWS_API?per_page=10"); then
            success_count=$(echo "$workflow_data" | jq '[.workflow_runs[] | select(.conclusion == "success")] | length')
            failure_count=$(echo "$workflow_data" | jq '[.workflow_runs[] | select(.conclusion == "failure")] | length')
            total_runs=$(echo "$workflow_data" | jq '.workflow_runs | length')
            
            if [[ $total_runs -gt 0 ]]; then
              success_rate=$((success_count * 100 / total_runs))
              echo "âœ… Workflows Success Rate: ${success_rate}% ($success_count/$total_runs)"
            else
              echo "ğŸ“ Aucun workflow rÃ©cent trouvÃ©"
            fi
          fi

  # ==========================================================================
  # JOB 3: GÃ‰NÃ‰RATION STATUS BADGES
  # ==========================================================================
  
  update-badges:
    name: ğŸ·ï¸ Update Status Badges
    runs-on: ubuntu-latest
    needs: [monitor-services, collect-metrics]
    if: always()
    
    steps:
      - name: ğŸ·ï¸ Generate Status Badges
        run: |
          echo "ğŸ·ï¸ GÃ©nÃ©ration badges de statut"
          
          # Configuration badges selon santÃ© globale
          health="${{ needs.monitor-services.outputs.overall-health }}"
          
          case "$health" in
            "healthy")
              badge_color="brightgreen"
              badge_message="Operational"
              ;;
            "degraded")
              badge_color="yellow"
              badge_message="Degraded"
              ;;
            "critical")
              badge_color="red"
              badge_message="Critical"
              ;;
            *)
              badge_color="lightgrey"
              badge_message="Unknown"
              ;;
          esac
          
          echo "ğŸ“Š Status Badge: $badge_message ($badge_color)"
          
          # URLs badges (shields.io)
          echo "ğŸ”— Badge URLs gÃ©nÃ©rÃ©es:"
          echo "Status: https://img.shields.io/badge/Status-$badge_message-$badge_color"
          echo "Backend: https://img.shields.io/badge/Backend-${{ needs.monitor-services.outputs.backend-status }}-$badge_color"
          echo "Database: https://img.shields.io/badge/Database-${{ needs.monitor-services.outputs.database-status }}-$badge_color"

  # ==========================================================================
  # JOB 4: NOTIFICATIONS Ã‰QUIPE
  # ==========================================================================
  
  notify-team:
    name: ğŸ“¢ Team Notifications
    runs-on: ubuntu-latest
    needs: [monitor-services, collect-metrics]
    if: always() && (needs.monitor-services.outputs.overall-health == 'critical' || github.event.inputs.notify_team == 'true')
    
    steps:
      
      - name: ğŸ“Š Check Slack webhook availability
        id: check-slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "has_slack_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_slack_webhook=false" >> $GITHUB_OUTPUT
          fi
         
      - name: ğŸ“¢ Slack notification
        if: steps.check-slack.outputs.has_slack_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ needs.monitor-services.outputs.overall-health == 'critical' && 'ğŸš¨ ALERT' || 'ğŸ“Š' }} TaxasGE Status Dashboard",
              "attachments": [
                {
                  "color": "${{ needs.monitor-services.outputs.overall-health == 'healthy' && 'good' || needs.monitor-services.outputs.overall-health == 'critical' && 'danger' || 'warning' }}",
                  "fields": [
                    {
                      "title": "Overall Health",
                      "value": "${{ needs.monitor-services.outputs.overall-health }}",
                      "short": true
                    },
                    {
                      "title": "Backend API",
                      "value": "${{ needs.monitor-services.outputs.backend-status }}",
                      "short": true
                    },
                    {
                      "title": "Database",
                      "value": "${{ needs.monitor-services.outputs.database-status }}",
                      "short": true
                    },
                    {
                      "title": "Firebase",
                      "value": "${{ needs.monitor-services.outputs.firebase-status }}",
                      "short": true
                    },
                    {
                      "title": "Timestamp",
                      "value": "$(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)",
                      "short": false
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“Š Status Summary
        run: |
          echo "ğŸ“Š TaxasGE Status Dashboard Summary"
          echo "=================================="
          echo "ğŸ• Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸ¯ Overall Health: ${{ needs.monitor-services.outputs.overall-health }}"
          echo "ğŸš€ Backend: ${{ needs.monitor-services.outputs.backend-status }}"
          echo "ğŸ—„ï¸ Database: ${{ needs.monitor-services.outputs.database-status }}"
          echo "ğŸ”¥ Firebase: ${{ needs.monitor-services.outputs.firebase-status }}"
          echo ""
          echo "ğŸ“ˆ Next check: 15 minutes"
          echo "ğŸ“§ Notifications: ${{ needs.monitor-services.outputs.overall-health == 'critical' && 'SENT' || 'None' }}"

# ============================================================================
# CONCURRENCY CONTROL
# ============================================================================
concurrency:
  group: status-dashboard
  cancel-in-progress: true # Annuler les checks prÃ©cÃ©dents

# ============================================================================
# WORKFLOW SUMMARY
# ============================================================================
# Ce workflow Status Dashboard pour TaxasGE effectue:
# 1. ğŸ” Monitoring services core (Backend, Database, Firebase)
# 2. ğŸ“ˆ Collection mÃ©triques performance et GitHub
# 3. ğŸ·ï¸ GÃ©nÃ©ration badges statut automatiques
# 4. ğŸ“¢ Notifications Ã©quipe en cas de problÃ¨me critique
#
# ExÃ©cution: Toutes les 15min + Ã©vÃ©nements workflow + manuel
# Monitoring: API endpoints, Supabase, Firebase services
# Alertes: Slack notifications pour incidents critiques
# ============================================================================