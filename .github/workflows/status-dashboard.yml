# ============================================================================
# .github/workflows/status-dashboard.yml
# Dashboard de statut en temps rÃ©el (mise Ã  jour README automatique)
# ============================================================================

---
name: ðŸ“Š Status Dashboard Update

on:
  workflow_run:
    workflows: ["ðŸ“± Mobile CI/CD Production", "ðŸ Backend CI/CD Production"]
    types: [completed]
  schedule:
    - cron: '*/30 * * * *' # Toutes les 30 minutes

jobs:
  update-dashboard:
    name: ðŸ“Š Update Status Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“Š Generate Status Badges
        run: |
          # CrÃ©ation du fichier de status
          cat > STATUS.md << 'EOF'
          # ðŸš€ TaxasGE - Status Dashboard
          
          > **Last updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ðŸ”„ Build Status
          
          | Component | Status | Last Build | Coverage |
          |-----------|--------|------------|----------|
          | ðŸ“± Mobile App | ![Mobile CI](https://github.com/${{ github.repository }}/workflows/ðŸ“±%20Mobile%20CI/CD%20Production/badge.svg) | - | - |
          | ðŸ Backend API | ![Backend CI](https://github.com/${{ github.repository }}/workflows/ðŸ%20Backend%20CI/CD%20Production/badge.svg) | - | [![codecov](https://codecov.io/gh/${{ github.repository }}/branch/develop/graph/badge.svg)](https://codecov.io/gh/${{ github.repository }}) |
          
          ## ðŸ“Š Quick Metrics
          
          - ðŸ—ï¸ **Deployments this week:** $(git log --since="7 days ago" --oneline | wc -l)
          - ðŸ› **Open issues:** $(curl -s https://api.github.com/repos/${{ github.repository }}/issues?state=open | jq length)
          - ðŸ”€ **Open PRs:** $(curl -s https://api.github.com/repos/${{ github.repository }}/pulls?state=open | jq length)
          
          ## ðŸŒ Environment Status
          
          | Environment | URL | Status | Last Deploy |
          |-------------|-----|--------|-------------|
          | ðŸ§ª Development | [taxasge-dev.web.app](https://taxasge-dev.web.app) | ![Website](https://img.shields.io/website?url=https%3A//taxasge-dev.web.app) | $(git log develop -1 --format="%cd" --date=short) |
          | ðŸ­ Production | [taxasge-prod.web.app](https://taxasge-prod.web.app) | ![Website](https://img.shields.io/website?url=https%3A//taxasge-prod.web.app) | $(git log main -1 --format="%cd" --date=short) |
          
          ## ðŸ”— Quick Links
          
          - ðŸ“Š [GitHub Actions](https://github.com/${{ github.repository }}/actions)
          - ðŸ› [Issues](https://github.com/${{ github.repository }}/issues)
          - ðŸ”€ [Pull Requests](https://github.com/${{ github.repository }}/pulls)
          - ðŸ“š [Wiki](https://github.com/${{ github.repository }}/wiki)
          
          ---
          *Generated automatically by GitHub Actions*
          EOF
          
          # Substitution des variables
          sed -i "s/\$(date -u '+%Y-%m-%d %H:%M:%S UTC')/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/g" STATUS.md
          sed -i "s/\$(git log --since=\"7 days ago\" --oneline | wc -l)/$(git log --since="7 days ago" --oneline | wc -l)/g" STATUS.md
          sed -i "s/\$(git log develop -1 --format=\"%cd\" --date=short)/$(git log develop -1 --format="%cd" --date=short 2>/dev/null || echo "N/A")/g" STATUS.md
          sed -i "s/\$(git log main -1 --format=\"%cd\" --date=short)/$(git log main -1 --format="%cd" --date=short 2>/dev/null || echo "N/A")/g" STATUS.md
      
      - name: ðŸ’¾ Commit Status Update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ $(git status --porcelain) ]]; then
            git add STATUS.md
            git commit -m "ðŸ¤– Auto-update status dashboard [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
