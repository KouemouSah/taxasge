---
name: ğŸ“Š Status Dashboard Update

on:
  workflow_run:
    # âœ… CORRECTION: Ajout du workflow de dÃ©ploiement manquant
    workflows: [
      "ğŸ“± Mobile CI/CD Production", 
      "ğŸ Backend CI/CD Production",
      "ğŸš€ Deploy Backend to Firebase",
      "ğŸš€ Distribute Mobile App (Android)"
    ]
    types: [completed]
  schedule:
    # âœ… CORRECTION: Syntaxe cron corrigÃ©e (suppression du '*' en trop)
    - cron: '0 */6 * * *'  # Toutes les 6 heures
  workflow_dispatch:

jobs:
  update-dashboard:
    name: ğŸ“Š Update Status Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # âœ… CORRECTION: GÃ©nÃ©ration STATUS.md sans sed complexe + amÃ©liorations
      - name: ğŸ“ Create Status Dashboard
        run: |
          REPO_NAME="${{ github.repository }}"
          CURRENT_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          BRANCH="${{ github.ref_name }}"
          RUN_ID="${{ github.run_id }}"
          
          cat > STATUS.md << EOF
          # ğŸš€ TaxasGE - Status Dashboard
          
          > **Last updated:** $CURRENT_DATE  
          > **Triggered by:** ${{ github.event_name }} on branch \`$BRANCH\`
          
          ## ğŸ”„ Build Status
          
          | Component | Status | Last Run |
          |-----------|--------|----------|
          | ğŸ“± Mobile CI/CD | ![Mobile CI](https://github.com/$REPO_NAME/workflows/ğŸ“±%20Mobile%20CI%2FCD%20Production/badge.svg) | [![Mobile](https://img.shields.io/github/actions/workflow/status/$REPO_NAME/mobile-ci.yml?branch=develop&label=develop)](https://github.com/$REPO_NAME/actions/workflows/mobile-ci.yml) |
          | ğŸ Backend CI/CD | ![Backend CI](https://github.com/$REPO_NAME/workflows/ğŸ%20Backend%20CI%2FCD%20Production/badge.svg) | [![Backend](https://img.shields.io/github/actions/workflow/status/$REPO_NAME/backend-ci.yml?branch=develop&label=develop)](https://github.com/$REPO_NAME/actions/workflows/backend-ci.yml) |
          | ğŸš€ Backend Deploy | ![Deploy](https://github.com/$REPO_NAME/workflows/ğŸš€%20Deploy%20Backend%20to%20Firebase/badge.svg) | [![Deploy](https://img.shields.io/github/actions/workflow/status/$REPO_NAME/deploy-backend.yml?branch=develop&label=develop)](https://github.com/$REPO_NAME/actions/workflows/deploy-backend.yml) |
          | ğŸ“± Mobile Distribution | ![Distribute](https://github.com/$REPO_NAME/workflows/ğŸš€%20Distribute%20Mobile%20App%20%28Android%29/badge.svg) | [![Distribute](https://img.shields.io/github/actions/workflow/status/$REPO_NAME/distribute-mobile.yml?branch=develop&label=develop)](https://github.com/$REPO_NAME/actions/workflows/distribute-mobile.yml) |
          
          ## ğŸ“Š Project Overview
          
          - ğŸ—ï¸ **Status:** MVP Development (Phase 1 - Infrastructure)
          - ğŸ—„ï¸ **Database:** Supabase PostgreSQL (taxasge-db)
          - ğŸ¤– **AI Model:** Ready (0.41MB, 100% accuracy, 62k questions)
          - ğŸ“± **Platforms:** Android, iOS, Web
          - ğŸ›ï¸ **Data:** 547 taxes from Equatorial Guinea
          
          ## ğŸŒ Environments
          
          | Environment | URL | Status | Auto-Deploy |
          |-------------|-----|--------|-------------|
          | ğŸ§ª Development | [taxasge-dev.web.app](https://taxasge-dev.web.app) | [![Dev](https://img.shields.io/website?url=https%3A%2F%2Ftaxasge-dev.web.app&label=dev)](https://taxasge-dev.web.app) | âœ… develop branch |
          | ğŸ­ Production | [taxasge-prod.web.app](https://taxasge-prod.web.app) | [![Prod](https://img.shields.io/website?url=https%3A%2F%2Ftaxasge-prod.web.app&label=prod)](https://taxasge-prod.web.app) | âš ï¸ Manual deploy |
          
          ## ğŸ“‹ Phase 1 Progress Tracker
          
          ### âœ… Completed (Weeks 1-2)
          - [x] ğŸ”§ CI/CD Pipelines Setup (4 workflows)
          - [x] ğŸ”¥ Firebase Configuration (dev + prod)
          - [x] ğŸ¤– AI Model Training & Integration
          - [x] ğŸ—„ï¸ Database Schema Design (PostgreSQL)
          - [x] ğŸ”— Supabase Integration & Configuration
          - [x] âš™ï¸ GitHub Actions Workflows Correction
          - [x] ğŸ—ï¸ Infrastructure DevOps 100% Ready
          
          ### ğŸš§ In Development (Phase 1 - Current)
          - [ ] ğŸ“± React Native Mobile App Structure
          - [ ] ğŸ FastAPI Backend Implementation
          - [ ] ğŸ“Š Data Import (547 taxes â†’ PostgreSQL)
          - [ ] ğŸ§ª Testing & Validation Infrastructure
          - [ ] ğŸ“‹ Sprint 1.1 Completion
          
          ### ğŸ”„ Next Phases (Weeks 3-12)
          - [ ] ğŸ’³ Payment Integration (Bange)
          - [ ] ğŸŒ Web Admin Dashboard
          - [ ] ğŸ¤– Offline Chatbot Integration
          - [ ] ğŸš€ Production Deployment
          
          ## ğŸ”— Quick Access
          
          ### ğŸ“Š Development Tools
          - [GitHub Actions](https://github.com/$REPO_NAME/actions) - CI/CD Pipelines
          - [GitHub Issues](https://github.com/$REPO_NAME/issues) - Bug Tracking
          - [Pull Requests](https://github.com/$REPO_NAME/pulls) - Code Reviews
          - [Project Board](https://github.com/$REPO_NAME/projects) - Sprint Planning
          
          ### ğŸ”¥ Firebase Resources
          - [Firebase Console - Dev](https://console.firebase.google.com/project/taxasge-dev) - Development Environment
          - [Firebase Console - Prod](https://console.firebase.google.com/project/taxasge-prod) - Production Environment
          - [App Distribution](https://console.firebase.google.com/project/taxasge-dev/appdistribution) - Mobile Testing
          
          ### ğŸ—„ï¸ Database & API
          - [Supabase Dashboard](https://supabase.com/dashboard/project/taxasge-db) - Database Management
          - [API Documentation](https://taxasge-dev.web.app/docs) - FastAPI Swagger UI
          - [API Health Check](https://taxasge-dev.web.app/health) - Service Status
          
          ## ğŸ“ˆ Latest Metrics
          
          | Metric | Value | Status |
          |--------|-------|--------|
          | ğŸ—ï¸ Infrastructure Setup | 100% | âœ… Complete |
          | ğŸ“Š Data Preparation | 95% | ğŸŸ¡ In Progress |
          | ğŸ“± Mobile Development | 15% | ğŸ”´ Starting |
          | ğŸ Backend Development | 25% | ğŸŸ¡ In Progress |
          | ğŸ§ª Testing Coverage | 80% | ğŸŸ¡ Good |
          | ğŸ“– Documentation | 90% | âœ… Excellent |
          
          ## ğŸ”” Last 5 Actions
          
          - ğŸ¤– Dashboard updated automatically
          - âš™ï¸ Workflows corrected for root structure
          - ğŸ”§ Infrastructure finalization in progress
          - ğŸ“‹ Sprint 1.1 tasks execution
          - ğŸš€ Phase 1 development started
          
          ---
          
          <details>
          <summary>ğŸ“± Mobile App Distribution</summary>
          
          ### Latest APK Builds
          - **Development:** Available via Firebase App Distribution
          - **Test Group:** testeurs-internes
          - **Download:** [Firebase Console](https://console.firebase.google.com/project/taxasge-dev/appdistribution)
          
          </details>
          
          <details>
          <summary>ğŸ”§ Technical Stack</summary>
          
          ### Frontend
          - **Mobile:** React Native 0.72
          - **Navigation:** React Navigation 6.x
          - **State:** Context API + Hooks
          - **AI:** TensorFlow Lite (offline)
          
          ### Backend
          - **API:** FastAPI + Python 3.11
          - **Database:** PostgreSQL via Supabase
          - **Functions:** Firebase Functions
          - **Auth:** Firebase Authentication
          
          ### DevOps
          - **CI/CD:** GitHub Actions (4 workflows)
          - **Hosting:** Firebase Hosting
          - **Monitoring:** Built-in Firebase Analytics
          - **Distribution:** Firebase App Distribution
          
          </details>
          
          ---
          *ğŸ¤– Auto-generated by GitHub Actions - Run #$RUN_ID*  
          *ğŸ“… Next update: Every 6 hours or after workflow completion*
          EOF
      
      - name: ğŸ’¾ Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # VÃ©rification s'il y a des changements
          if ! git diff --quiet STATUS.md; then
            git add STATUS.md
            git commit -m "ğŸ¤– Update status dashboard [skip ci]
            
            - Updated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            - Triggered by: ${{ github.event_name }}
            - Branch: ${{ github.ref_name }}
            - Run: ${{ github.run_id }}"
            
            # Push avec retry en cas d'Ã©chec
            for i in {1..3}; do
              if git push; then
                echo "âœ… Dashboard updated successfully"
                break
              else
                echo "âš ï¸ Push failed, retrying in 5s... (attempt $i/3)"
                sleep 5
                if [ $i -eq 3 ]; then
                  echo "âŒ Failed to push after 3 attempts"
                  exit 1
                fi
              fi
            done
          else
            echo "â„¹ï¸ No changes to commit - dashboard already up to date"
          fi
