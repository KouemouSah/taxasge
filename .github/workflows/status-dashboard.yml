# .github/workflows/status-dashboard.yml
name: ğŸ“Š Status Dashboard Update

on:
  workflow_run:
    workflows: ["ğŸ“± Mobile CI/CD Production", "ğŸ Backend CI/CD Production"]
    types: [completed]
  schedule:
    - cron: '0 */6 * * *' # Toutes les 6 heures (moins frÃ©quent)
  workflow_dispatch: # Permettre dÃ©clenchement manuel

jobs:
  update-dashboard:
    name: ğŸ“Š Update Status Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Historique complet
      
      - name: ğŸ“Š Generate Status Information
        run: |
          echo "ğŸ“Š Generating TaxasGE status dashboard..."
          
          # Variables de base
          CURRENT_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          REPO_NAME="${{ github.repository }}"
          
          # Collecte des mÃ©triques Git
          COMMITS_WEEK=$(git log --since="7 days ago" --oneline | wc -l)
          LAST_COMMIT_DEVELOP=$(git log develop -1 --format="%cd" --date=short 2>/dev/null || echo "N/A")
          LAST_COMMIT_MAIN=$(git log main -1 --format="%cd" --date=short 2>/dev/null || echo "N/A")
          
          echo "ğŸ“ˆ Metrics collected:"
          echo "- Commits this week: $COMMITS_WEEK"
          echo "- Last develop deploy: $LAST_COMMIT_DEVELOP"
          echo "- Last main deploy: $LAST_COMMIT_MAIN"
      
      - name: ğŸ“ Create Status Dashboard
        run: |
          # CrÃ©ation du fichier STATUS.md
          cat > STATUS.md << 'DASHBOARD_EOF'
          # ğŸš€ TaxasGE - Status Dashboard
          
          > **Last updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ğŸ”„ Build Status
          
          | Component | Status | Coverage |
          |-----------|--------|----------|
          | ğŸ“± Mobile App | ![Mobile CI](https://github.com/${{ github.repository }}/workflows/ğŸ“±%20Mobile%20CI%2FCD%20Production/badge.svg) | - |
          | ğŸ Backend API | ![Backend CI](https://github.com/${{ github.repository }}/workflows/ğŸ%20Backend%20CI%2FCD%20Production/badge.svg) | - |
          | ğŸš€ Deploy Backend | ![Deploy](https://github.com/${{ github.repository }}/workflows/Deploy%20Backend%20to%20Firebase/badge.svg) | - |
          
          ## ğŸ“Š Project Metrics
          
          - ğŸ—ï¸ **Active workflows:** 5
          - ğŸ“… **Project status:** In Development (MVP)
          - ğŸ—„ï¸ **Database:** PostgreSQL (planned)
          - ğŸ¤– **AI Model:** Ready (0.41MB, 100% accuracy)
          - ğŸ“± **Target platforms:** Android, iOS, Web
          
          ## ğŸŒ Environment Status
          
          | Environment | URL | Purpose |
          |-------------|-----|---------|
          | ğŸ§ª Development | [taxasge-dev.web.app](https://taxasge-dev.web.app) | Auto-deploy from develop |
          | ğŸ­ Production | [taxasge-prod.web.app](https://taxasge-prod.web.app) | Manual deploy from main |
          
          ## ğŸ“‹ MVP Progress
          
          ### âœ… Completed
          - [x] Project structure and CI/CD pipelines
          - [x] Firebase configuration (dev/prod)
          - [x] AI model training (547 taxes, 62K questions)
          - [x] Database schema design
          - [x] Multilingual support (ES/FR/EN)
          
          ### ğŸš§ In Progress
          - [ ] React Native mobile app development
          - [ ] Backend API implementation
          - [ ] PostgreSQL database setup
          - [ ] Payment integration (Bange)
          - [ ] Web admin dashboard
          
          ### ğŸ“… Planned
          - [ ] User authentication system
          - [ ] Offline chatbot integration
          - [ ] Tax calculation engine
          - [ ] Receipt generation system
          - [ ] Analytics and reporting
          
          ## ğŸ”— Quick Links
          
          - ğŸ“Š [GitHub Actions](https://github.com/${{ github.repository }}/actions)
          - ğŸ› [Issues](https://github.com/${{ github.repository }}/issues)
          - ğŸ”€ [Pull Requests](https://github.com/${{ github.repository }}/pulls)
          - ğŸ”¥ [Firebase Console Dev](https://console.firebase.google.com/project/taxasge-dev)
          - ğŸ­ [Firebase Console Prod](https://console.firebase.google.com/project/taxasge-prod)
          
          ## ğŸ“ˆ Recent Activity
          
          - **Latest commits:** Check [commit history](https://github.com/${{ github.repository }}/commits)
          - **Open issues:** Check [issues page](https://github.com/${{ github.repository }}/issues)
          - **Active PRs:** Check [pull requests](https://github.com/${{ github.repository }}/pulls)
          
          ---
          *ğŸ¤– Generated automatically by GitHub Actions*
          DASHBOARD_EOF
          
          # Substitution des variables GitHub
          sed -i "s/\${{ github.repository }}/${{ github.repository }}/g" STATUS.md
          
          echo "âœ… STATUS.md created successfully"
      
      - name: ğŸ’¾ Commit Status Update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # VÃ©rification des changements
          if git diff --quiet STATUS.md 2>/dev/null; then
            echo "ğŸ“Š No changes to STATUS.md"
          else
            echo "ğŸ“ STATUS.md has changes, committing..."
            git add STATUS.md
            git commit -m "ğŸ¤– Auto-update status dashboard [skip ci]"
            
            # Push avec retry
            for i in {1..3}; do
              if git push; then
                echo "âœ… Status dashboard updated successfully"
                break
              else
                echo "âš ï¸ Push failed, retrying in 5s..."
                sleep 5
              fi
            done
          fi
