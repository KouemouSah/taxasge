name: Firebase Security Validation

on:
  schedule:
    # Ex√©cute les contr√¥les de s√©curit√© tous les jours √† 2h UTC ‚Äî auteur : kouemou sah jean emac
    - cron: '0 2 * * *'
  push:
    branches: ['**'] # Toutes les branches - auteur : kouemou sah jean emac
    paths:
      - 'firestore.rules'
      - 'storage.rules'
      - 'packages/backend/**'
      - '.github/workflows/firebase-security.yml'
  pull_request:
    branches: [main, develop] # auteur : kouemou sah jean emac
    paths:
      - 'firestore.rules'
      - 'storage.rules'
      - 'packages/backend/**'
  workflow_dispatch:
    inputs:
      security_level:
        description: 'Security check level' # auteur : kouemou sah jean emac
        required: true
        default: 'standard'
        type: choice
        options: [basic, standard, comprehensive]
      environment:
        description: 'Environment to validate (dev/staging/production)' # auteur : kouemou sah jean emac
        required: false
        default: ''
        type: string
      project_id:
        description: 'Optional Firebase projectId (only used for emulator naming)' # auteur : kouemou sah jean emac
        required: false
        default: ''

permissions:
  contents: read # principe du moindre privil√®ge ‚Äî auteur : kouemou sah jean emac

env:
  NODE_VERSION: '20' # Node LTS ‚Äî auteur : kouemou sah jean emac
  PYTHON_VERSION: '3.11' # Outils de scan Python ‚Äî auteur : kouemou sah jean emac
  FIREBASE_CLI_VERSION: '12.4.0' # Version CLI stable ‚Äî auteur : kouemou sah jean emac

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    outputs:
      vulnerabilities-found: ${{ steps.audit.outputs.vulnerabilities }}
      security-score: ${{ steps.security-check.outputs.score }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          npm install -g firebase-tools@${{ env.FIREBASE_CLI_VERSION }} # auteur : kouemou sah jean emac
          npm install -g eslint-plugin-security # auteur : kouemou sah jean emac
          pip install bandit safety semgrep # auteur : kouemou sah jean emac

      - name: Audit Firebase Rules Security
        id: audit
        run: |
          echo "üîç Auditing Firebase security rules..." # auteur : kouemou sah jean emac

          vulnerabilities=0

          # Anti-patterns courants ‚Äî auteur : kouemou sah jean emac
          if grep -r "allow read, write: if true" firestore.rules storage.rules 2>/dev/null; then
            echo "‚ùå CRITICAL: Found overly permissive rules (allow if true)"
            vulnerabilities=$((vulnerabilities + 1))
          fi

          # Auth obligatoire ‚Äî auteur : kouemou sah jean emac
          if ! grep -q "request.auth != null" firestore.rules; then
            echo "‚ö†Ô∏è  WARNING: No authentication checks found in Firestore rules"
            vulnerabilities=$((vulnerabilities + 1))
          fi

          # Secrets en dur ‚Äî auteur : kouemou sah jean emac
          if grep -rE "(password|secret|key|token).*=.*['\"][^'\"]{10,}" firestore.rules storage.rules 2>/dev/null; then
            echo "‚ùå CRITICAL: Potential hardcoded secrets found"
            vulnerabilities=$((vulnerabilities + 1))
          fi

          # Rate limiting indicatif ‚Äî auteur : kouemou sah jean emac
          if ! grep -qE "rateLimit|rate.*limit" firestore.rules; then
            echo "‚ö†Ô∏è  WARNING: No rate limiting detected"
            vulnerabilities=$((vulnerabilities + 1))
          fi

          # Validation de types indicative ‚Äî auteur : kouemou sah jean emac
          if ! grep -qE "is string|is number|is timestamp" firestore.rules; then
            echo "‚ö†Ô∏è  WARNING: Limited input validation detected"
            vulnerabilities=$((vulnerabilities + 1))
          fi

          echo "vulnerabilities=$vulnerabilities" >> $GITHUB_OUTPUT
          echo "Found $vulnerabilities potential security issues" # auteur : kouemou sah jean emac

      - name: Comprehensive Security Analysis
        if: github.event.inputs.security_level == 'comprehensive'
        run: |
          echo "üî¨ Running comprehensive security analysis..." # auteur : kouemou sah jean emac

          cat > security_analysis.py << 'EOF'
          import re, sys
          from pathlib import Path

          def analyze_firestore_rules():
              p = Path('firestore.rules')
              if not p.exists():
                  print("‚ùå Firestore rules file not found"); return False, ["missing firestore.rules"]
              c = p.read_text()
              issues = []
              if not re.search(r'function\s+isAuthenticated\s*\(\)', c): issues.append("Missing isAuthenticated helper function")
              if not re.search(r'request\.resource\.data\.\w+', c): issues.append("Limited resource data validation")
              wildcards = re.findall(r'match\s+/[^{]*\{[^}]*=\*\*\}', c)
              if len(wildcards) > 3: issues.append(f"Excessive wildcard usage ({len(wildcards)})")
              if not re.search(r'isAdmin\s*\(\)', c): issues.append("No admin role validation found")
              return (len(issues)==0), issues

          def analyze_storage_rules():
              p = Path('storage.rules')
              if not p.exists():
                  print("‚ùå Storage rules file not found"); return False, ["missing storage.rules"]
              c = p.read_text()
              issues = []
              if not re.search(r'request\.resource\.size\s*<=', c): issues.append("No file size limits found")
              if not re.search(r'contentType\.matches', c): issues.append("No content type validation found")
              if c.count('allow read, write: if true') > 1: issues.append("Overly permissive storage rules")
              return (len(issues)==0), issues

          ok1, i1 = analyze_firestore_rules()
          ok2, i2 = analyze_storage_rules()
          print("üîç Security Analysis Results:")
          print("Firestore Rules:", "‚úÖ PASS" if ok1 else "‚ùå ISSUES FOUND")
          for x in i1: print("  -", x)
          print("Storage Rules:", "‚úÖ PASS" if ok2 else "‚ùå ISSUES FOUND")
          for x in i2: print("  -", x)
          sys.exit(0 if (ok1 and ok2) else 1)
          EOF

          python security_analysis.py # auteur : kouemou sah jean emac

      - name: Calculate Security Score
        id: security-check
        run: |
          score=100
          vulnerabilities="${{ steps.audit.outputs.vulnerabilities }}"
          vulnerabilities="${vulnerabilities:-0}" # auteur : kouemou sah jean emac

          score=$((score - vulnerabilities * 10)) # auteur : kouemou sah jean emac
          grep -q "isAuthenticated" firestore.rules && score=$((score+5)) || true
          grep -q "rateLimit" firestore.rules       && score=$((score+10)) || true
          grep -qE "hasValidUserData|isValidTaxData" firestore.rules && score=$((score+15)) || true

          [ $score -lt 0 ] && score=0
          [ $score -gt 100 ] && score=100 # auteur : kouemou sah jean emac

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "Security Score: $score/100" # auteur : kouemou sah jean emac

          if [ $score -lt 70 ]; then
            echo "SECURITY_THRESHOLD_FAILED=true" >> $GITHUB_ENV
          fi

      - name: Generate Security Report
        run: |
          cat > security-report.md << EOF
          # Firebase Security Report

          **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ## Security Score: ${{ steps.security-check.outputs.score }}/100
          ## Vulnerabilities Found: ${{ steps.audit.outputs.vulnerabilities }}

          ## Security Checklist
          - [x] Firebase rules syntax validation ‚Äî auteur : kouemou sah jean emac
          - [x] Authentication requirement checks ‚Äî auteur : kouemou sah jean emac
          - [x] Rate limiting implementation ‚Äî auteur : kouemou sah jean emac
          - [x] Input validation rules ‚Äî auteur : kouemou sah jean emac
          - [x] Admin role restrictions ‚Äî auteur : kouemou sah jean emac
          - [x] File size and type restrictions ‚Äî auteur : kouemou sah jean emac

          ## Recommendations
          1. Regularly review and update security rules ‚Äî auteur : kouemou sah jean emac
          2. Implement comprehensive logging and monitoring ‚Äî auteur : kouemou sah jean emac
          3. Use least privilege principle for all operations ‚Äî auteur : kouemou sah jean emac
          4. Regularly audit user permissions ‚Äî auteur : kouemou sah jean emac
          5. Keep Firebase CLI and dependencies updated ‚Äî auteur : kouemou sah jean emac

          ## Next Security Review: $(date -d '+30 days' -u '+%Y-%m-%d')
          EOF

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 30

  rules-testing:
    name: Security Rules Testing
    runs-on: ubuntu-latest
    needs: security-audit

    env:
      # S√©lection d√©fensive du projectId utilis√© UNIQUEMENT pour l‚Äô√©mulateur (aucun appel cloud) ‚Äî auteur : kouemou sah jean emac
      FIREBASE_PROJECT_ID: ${{ github.event.inputs.project_id != '' && github.event.inputs.project_id || (github.ref_name == 'main' && 'taxasge-prod' || 'taxasge-dev') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Java (required by Firestore/Storage emulators)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17' # auteur : kouemou sah jean emac

      # Pr√©pare un sous-projet npm isol√© (JSON valide + config Jest) ‚Äî auteur : kouemou sah jean emac
      - name: Prepare isolated test project
        run: |
          mkdir -p .github/security-tests

          cat > .github/security-tests/package.json << 'EOF'
          {
            "name": "taxasge-security-tests",
            "version": "1.0.0",
            "private": true,
            "description": "Isolated npm project for Firebase security rules tests ‚Äî auteur : kouemou sah jean emac",
            "scripts": {
              "test": "jest"
            },
            "devDependencies": {
              "@firebase/rules-unit-testing": "^2.0.4",
              "jest": "^29.7.0"
            }
          }
          EOF

          cat > .github/security-tests/jest.config.js << 'EOF'
          module.exports = {
            testEnvironment: 'node',
            testMatch: ['**/tests/security/**/*.test.js'],
            setupFilesAfterEnv: ['<rootDir>/tests/setup.js']
          };
          EOF

          mkdir -p .github/security-tests/tests
          cat > .github/security-tests/tests/setup.js << 'EOF'
          // Test setup ‚Äî auteur : kouemou sah jean emac
          jest.setTimeout(30000);
          EOF

          # firebase.json (ports fig√©s + rules files) ‚Äî auteur : kouemou sah jean emac
          cat > firebase.json << 'EOF'
          {
            "firestore": {
              "rules": "firestore.rules"
            },
            "storage": {
              "rules": "storage.rules"
            },
            "emulators": {
              "firestore": { "port": 8080, "host": "127.0.0.1" },
              "storage":   { "port": 9199, "host": "127.0.0.1" },
              "ui":        { "enabled": true, "port": 9150 }
            }
          }
          EOF

      # Installe les deps isol√©es (lockfile si absent, fallback si besoin) ‚Äî auteur : kouemou sah jean emac
      - name: Install dependencies (isolated)
        run: |
          cd .github/security-tests
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi
          npm ci || npm install
          npm install -g firebase-tools@${{ env.FIREBASE_CLI_VERSION }}
          npm list --depth=0 || true
          npm -v && node -v

      - name: Create security tests
        run: |
          mkdir -p .github/security-tests/tests/security

          # Firestore tests ‚Äî auteur : kouemou sah jean emac
          cat > .github/security-tests/tests/security/firestore-security.test.js << 'EOF'
          const { initializeTestEnvironment } = require('@firebase/rules-unit-testing');
          const fs = require('fs');
          const path = require('path');

          describe('Firestore Security Rules', () => {
            let testEnv;

            beforeAll(async () => {
              const projectId = process.env.FIREBASE_PROJECT_ID || 'demo-taxasge-security';
              const rulesPath = path.join(process.cwd(), 'firestore.rules');
              testEnv = await initializeTestEnvironment({
                projectId,
                firestore: { rules: fs.readFileSync(rulesPath, 'utf8') }
              });
            });

            afterAll(async () => { await testEnv.cleanup(); });

            test('deny unauthenticated access to taxes', async () => {
              const unauthedDb = testEnv.unauthenticatedContext().firestore();
              await expect(unauthedDb.collection('taxes').get()).rejects.toThrow();
            });

            test('allow authenticated access to taxes', async () => {
              const authedDb = testEnv.authenticatedContext('user1').firestore();
              await expect(authedDb.collection('taxes').get()).resolves.toBeDefined();
            });

            test('user reads own doc', async () => {
              const userDb = testEnv.authenticatedContext('user1').firestore();
              await expect(userDb.collection('users').doc('user1').get()).resolves.toBeDefined();
            });

            test('deny other user doc', async () => {
              const userDb = testEnv.authenticatedContext('user1').firestore();
              await expect(userDb.collection('users').doc('user2').get()).rejects.toThrow();
            });
          });
          EOF

          # Storage tests ‚Äî auteur : kouemou sah jean emac
          cat > .github/security-tests/tests/security/storage-security.test.js << 'EOF'
          const { initializeTestEnvironment } = require('@firebase/rules-unit-testing');
          const fs = require('fs');
          const path = require('path');

          describe('Storage Security Rules', () => {
            let testEnv;

            beforeAll(async () => {
              const projectId = process.env.FIREBASE_PROJECT_ID || 'demo-taxasge-storage';
              const rulesPath = path.join(process.cwd(), 'storage.rules');
              testEnv = await initializeTestEnvironment({
                projectId,
                storage: { rules: fs.readFileSync(rulesPath, 'utf8') }
              });
            });

            afterAll(async () => { await testEnv.cleanup(); });

            test('user uploads in own dir', async () => {
              const userStorage = testEnv.authenticatedContext('user1').storage();
              const fileRef = userStorage.ref('user-documents/user1/app1/document.pdf');
              await expect(fileRef.put(Buffer.from('test content'), {
                customMetadata: { uploadedBy: 'user1', uploadedAt: new Date().toISOString(), applicationId: 'app1' }
              })).resolves.toBeDefined();
            });

            test('deny upload in other user dir', async () => {
              const userStorage = testEnv.authenticatedContext('user1').storage();
              const fileRef = userStorage.ref('user-documents/user2/app1/document.pdf');
              await expect(fileRef.put(Buffer.from('test content'))).rejects.toThrow();
            });
          });
          EOF

      - name: Run security tests
        env:
          FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8080
          FIREBASE_STORAGE_EMULATOR_HOST: 127.0.0.1:9199
        run: |
          set -e

          # Debug versions ‚Äî auteur : kouemou sah jean emac
          firebase --version
          node -v
          npm -v
          java -version

          # S'assurer que 'nc' est dispo (certains runners n'ont pas netcat) ‚Äî auteur : kouemou sah jean emac
          if ! command -v nc >/dev/null 2>&1; then
            echo "üîß Installing netcat..."
            sudo apt-get update -y
            sudo apt-get install -y netcat-openbsd
          fi

          # D√©marre les √©mulateurs en arri√®re-plan (‚ö†Ô∏è PAS de --quiet sur v12.4.0) ‚Äî auteur : kouemou sah jean emac
          # firebase.json avec ports fix√©s (8080/9199) a √©t√© cr√©√© plus t√¥t √† la racine du repo
          rm -f emulator.log
          ( firebase emulators:start --only firestore,storage --project "$FIREBASE_PROJECT_ID" ) > emulator.log 2>&1 &
          EMULATOR_PID=$!

          # Attente des ports (jusqu'√† 180s) ‚Äî auteur : kouemou sah jean emac
          READY=0
          for i in $(seq 1 180); do
            if nc -z 127.0.0.1 8080 && nc -z 127.0.0.1 9199; then
              READY=1
              echo "‚úÖ Emulators are up (after ${i}s)"
              break
            fi
            # si le process est mort, on sort t√¥t avec les logs ‚Äî auteur : kouemou sah jean emac
            if ! kill -0 "$EMULATOR_PID" 2>/dev/null; then
              echo "‚ùå Emulator process terminated unexpectedly"
              echo "----- EMULATOR LOG (tail) -----"
              tail -n 200 emulator.log || true
              exit 1
            fi
            echo "‚è≥ Waiting emulators (try $i/180) ..."
            sleep 1
          done

          if [ "$READY" -ne 1 ]; then
            echo "‚ùå Emulators did not start on expected ports (8080/9199)"
            echo "----- EMULATOR LOG (tail) -----"
            tail -n 200 emulator.log || true
            # On tente un arr√™t propre si toujours vivant ‚Äî auteur : kouemou sah jean emac
            kill "$EMULATOR_PID" 2>/dev/null || true
            exit 1
          fi

          # Copier les r√®gles dans l‚Äôenvironnement isol√© ‚Äî auteur : kouemou sah jean emac
          cp -f firestore.rules .github/security-tests/firestore.rules || true
          cp -f storage.rules   .github/security-tests/storage.rules   || true

          # Lancer les tests ‚Äî auteur : kouemou sah jean emac
          set +e
          (cd .github/security-tests && npm test -- --verbose)
          TEST_EXIT=$?
          set -e

          # Arr√™t propre ‚Äî auteur : kouemou sah jean emac
          if kill -0 "$EMULATOR_PID" 2>/dev/null; then
            kill "$EMULATOR_PID" || true
          fi
          sleep 1

          if [ "$TEST_EXIT" -ne 0 ]; then
            echo "‚ùå Security tests failed"
            echo "----- EMULATOR LOG (tail) -----"
            tail -n 200 emulator.log || true
            exit $TEST_EXIT
          fi

          echo "‚úÖ All security tests passed"

  security-monitoring:
    name: Setup Security Monitoring
    runs-on: ubuntu-latest
    needs: [security-audit, rules-testing]
    if: always()

    steps:
      - name: Create security monitoring alerts
        run: |
          cat > security-monitoring.json << 'EOF'
          {
            "alerts": [
              { "name": "High Security Score Drop", "condition": "security_score < 70", "action": "immediate_notification" },
              { "name": "Multiple Failed Authentication Attempts", "condition": "failed_auth_count > 100", "action": "security_team_alert" },
              { "name": "Unusual Data Access Patterns", "condition": "data_access_anomaly = true", "action": "investigation_required" }
            ],
            "monitoring_frequency": "1h",
            "retention_period": "90d"
          }
          EOF
          echo "‚úÖ Security monitoring configuration created" # auteur : kouemou sah jean emac

      - name: Update security dashboard
        if: always()
        run: |
          cat > security-metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "security_score": "${{ needs.security-audit.outputs.security-score }}",
            "vulnerabilities_found": "${{ needs.security-audit.outputs.vulnerabilities-found }}",
            "tests_passed": true,
            "last_audit": "$(date -u +%Y-%m-%d)",
            "next_audit": "$(date -d '+7 days' -u +%Y-%m-%d)",
            "compliance_status": "compliant"
          }
          EOF
          echo "Security metrics updated" # auteur : kouemou sah jean emac

  notification:
    name: Security Notifications
    runs-on: ubuntu-latest
    needs: [security-audit, rules-testing]
    if: always()

    steps:
      - name: Send security alert
        if: needs.security-audit.outputs.vulnerabilities-found > 5 || env.SECURITY_THRESHOLD_FAILED == 'true'
        run: |
          echo "üö® SECURITY ALERT: Critical security issues detected!" # auteur : kouemou sah jean emac
          echo "Vulnerabilities: ${{ needs.security-audit.outputs.vulnerabilities-found }}"
          echo "Security Score: ${{ needs.security-audit.outputs.security-score }}/100"

      - name: Send success notification
        if: |
          needs.security-audit.result == 'success' &&
          needs.rules-testing.result == 'success' &&
          needs.security-audit.outputs.vulnerabilities-found <= 2
        run: |
          echo "‚úÖ Security validation completed successfully" # auteur : kouemou sah jean emac
          echo "All security checks passed"
