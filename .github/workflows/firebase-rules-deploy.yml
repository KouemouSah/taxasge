name: Deploy Firebase Security Rules

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'firestore.rules'
      - 'storage.rules'
      - 'firestore.indexes.json'
      - '.github/workflows/firebase-rules-deploy.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'firestore.rules'
      - 'storage.rules'
      - 'firestore.indexes.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  FIREBASE_CLI_VERSION: '12.4.0'

jobs:
  validate-rules:
    name: Validate Security Rules
    runs-on: ubuntu-latest
    outputs:
      rules-changed: ${{ steps.changes.outputs.rules }}
      indexes-changed: ${{ steps.changes.outputs.indexes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for rule changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            rules:
              - 'firestore.rules'
              - 'storage.rules'
            indexes:
              - 'firestore.indexes.json'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Firebase CLI
        run: |
          npm install -g firebase-tools@${{ env.FIREBASE_CLI_VERSION }}
          firebase --version

      - name: Validate Firebase configuration
        run: |
          if [ ! -f firebase.json ]; then
            echo "Error: firebase.json not found"
            exit 1
          fi

          echo "Validating firebase.json structure..."
          node -e "
            const config = require('./firebase.json');
            if (!config.firestore || !config.storage) {
              console.error('Missing firestore or storage configuration');
              process.exit(1);
            }
            console.log('Firebase configuration is valid');
          "

      - name: Validate Firestore Rules syntax
        if: steps.changes.outputs.rules == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Validating Firestore rules syntax..."
          if [ -f firestore.rules ]; then
            # Use Node.js script to validate rules syntax
            node -e "
              const fs = require('fs');
              const path = 'firestore.rules';

              try {
                const content = fs.readFileSync(path, 'utf8');

                // Basic syntax validation
                if (!content.includes('rules_version')) {
                  throw new Error('Missing rules_version declaration');
                }

                if (!content.includes('service cloud.firestore')) {
                  throw new Error('Missing service cloud.firestore declaration');
                }

                // Check for balanced braces
                const openBraces = (content.match(/\{/g) || []).length;
                const closeBraces = (content.match(/\}/g) || []).length;

                if (openBraces !== closeBraces) {
                  throw new Error('Unbalanced braces in rules file');
                }

                // Check for common syntax patterns
                if (!content.includes('match') && content.length > 100) {
                  console.warn('Warning: No match statements found');
                }

                console.log('‚úÖ Firestore rules syntax validation passed');
              } catch (error) {
                console.error('‚ùå Firestore rules validation failed:', error.message);
                process.exit(1);
              }
            "
            echo "‚úÖ Firestore rules syntax is valid"
          else
            echo "Warning: firestore.rules file not found"
          fi

      - name: Validate Storage Rules syntax
        if: steps.changes.outputs.rules == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Validating Storage rules syntax..."
          if [ -f storage.rules ]; then
            # Use Node.js script to validate storage rules syntax
            node -e "
              const fs = require('fs');
              const path = 'storage.rules';

              try {
                const content = fs.readFileSync(path, 'utf8');

                // Basic syntax validation for storage rules
                if (!content.includes('rules_version')) {
                  throw new Error('Missing rules_version declaration');
                }

                if (!content.includes('service firebase.storage')) {
                  throw new Error('Missing service firebase.storage declaration');
                }

                // Check for balanced braces
                const openBraces = (content.match(/\{/g) || []).length;
                const closeBraces = (content.match(/\}/g) || []).length;

                if (openBraces !== closeBraces) {
                  throw new Error('Unbalanced braces in storage rules file');
                }

                // Check for match statements
                if (!content.includes('match') && content.length > 100) {
                  console.warn('Warning: No match statements found in storage rules');
                }

                console.log('‚úÖ Storage rules syntax validation passed');
              } catch (error) {
                console.error('‚ùå Storage rules validation failed:', error.message);
                process.exit(1);
              }
            "
            echo "‚úÖ Storage rules syntax is valid"
          else
            echo "Warning: storage.rules file not found"
          fi

      - name: Validate Firestore Indexes
        if: steps.changes.outputs.indexes == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Validating Firestore indexes..."
          if [ -f firestore.indexes.json ]; then
            # Validate JSON syntax
            cat firestore.indexes.json | jq empty || {
              echo "Error: Invalid JSON in firestore.indexes.json"
              exit 1
            }
            echo "‚úÖ Firestore indexes JSON is valid"
          else
            echo "Warning: firestore.indexes.json file not found"
          fi

      - name: Check security best practices
        run: |
          echo "Checking security best practices..."

          # Check if rules deny by default
          if grep -q "allow.*if false" firestore.rules; then
            echo "‚úÖ Found default deny rules"
          else
            echo "‚ùå Warning: No explicit default deny found"
          fi

          # Check for authentication requirements
          if grep -q "request.auth != null" firestore.rules; then
            echo "‚úÖ Authentication checks found"
          else
            echo "‚ùå Warning: No authentication checks found"
          fi

          # Check for rate limiting
          if grep -q "rateLimit" firestore.rules; then
            echo "‚úÖ Rate limiting implemented"
          else
            echo "‚ùå Warning: No rate limiting found"
          fi

  test-rules:
    name: Test Security Rules
    runs-on: ubuntu-latest
    needs: validate-rules
    if: needs.validate-rules.outputs.rules-changed == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g firebase-tools@${{ env.FIREBASE_CLI_VERSION }}
          npm install --save-dev @firebase/rules-unit-testing

      - name: Start Firebase emulators
        run: |
          firebase emulators:start --only firestore,storage --project demo-taxasge &
          sleep 10
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_STORAGE_EMULATOR_HOST: localhost:9199

      - name: Run basic rules tests
        run: |
          echo "Running basic security rules tests..."

          # Create a simple test script
          cat > test-rules.js << 'EOF'
          const { initializeTestEnvironment } = require('@firebase/rules-unit-testing');

          async function runTests() {
            const testEnv = await initializeTestEnvironment({
              projectId: 'demo-taxasge',
              firestore: {
                rules: require('fs').readFileSync('firestore.rules', 'utf8'),
                host: 'localhost',
                port: 8080
              },
              storage: {
                rules: require('fs').readFileSync('storage.rules', 'utf8'),
                host: 'localhost',
                port: 9199
              }
            });

            console.log('‚úÖ Rules loaded successfully in emulator');

            // Test unauthenticated access (should be denied)
            const unauthedDb = testEnv.unauthenticatedContext().firestore();
            try {
              await unauthedDb.collection('taxes').get();
              console.log('‚ùå Unauthenticated access should be denied');
              process.exit(1);
            } catch (error) {
              console.log('‚úÖ Unauthenticated access properly denied');
            }

            await testEnv.cleanup();
            console.log('‚úÖ All basic tests passed');
          }

          runTests().catch(console.error);
          EOF

          node test-rules.js

      - name: Stop emulators
        if: always()
        run: |
          pkill -f firebase || true

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate-rules, test-rules]
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@${{ env.FIREBASE_CLI_VERSION }}

      - name: Deploy Firestore rules to staging
        run: |
          echo "Deploying Firestore rules to staging..."
          firebase deploy --only firestore:rules --project taxasge-staging --token "${{ secrets.FIREBASE_TOKEN_STAGING }}" --force
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_STAGING }}

      - name: Deploy Storage rules to staging
        run: |
          echo "Deploying Storage rules to staging..."
          firebase deploy --only storage:rules --project taxasge-staging --token "${{ secrets.FIREBASE_TOKEN_STAGING }}" --force
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_STAGING }}

      - name: Deploy Firestore indexes to staging
        if: needs.validate-rules.outputs.indexes-changed == 'true'
        run: |
          echo "Deploying Firestore indexes to staging..."
          firebase deploy --only firestore:indexes --project taxasge-staging --token "${{ secrets.FIREBASE_TOKEN_STAGING }}" --force
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_STAGING }}

      - name: Verify deployment
        run: |
          echo "Verifying staging deployment..."
          # Add verification steps here
          echo "‚úÖ Staging deployment completed successfully"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate-rules, test-rules]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@${{ env.FIREBASE_CLI_VERSION }}

      - name: Create deployment backup
        run: |
          echo "Creating backup of current rules..."
          timestamp=$(date +%Y%m%d_%H%M%S)
          mkdir -p backups/$timestamp

          # Download current rules if they exist
          firebase firestore:rules:get --project taxasge-prod > backups/$timestamp/firestore.rules.backup 2>/dev/null || echo "No existing firestore rules"
          firebase storage:rules:get --project taxasge-prod > backups/$timestamp/storage.rules.backup 2>/dev/null || echo "No existing storage rules"

          echo "BACKUP_TIMESTAMP=$timestamp" >> $GITHUB_ENV
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_PRODUCTION }}

      - name: Deploy Firestore rules to production
        run: |
          echo "Deploying Firestore rules to production..."
          firebase deploy --only firestore:rules --project taxasge-prod --token "${{ secrets.FIREBASE_TOKEN_PRODUCTION }}" --force
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_PRODUCTION }}

      - name: Deploy Storage rules to production
        run: |
          echo "Deploying Storage rules to production..."
          firebase deploy --only storage:rules --project taxasge-prod --token "${{ secrets.FIREBASE_TOKEN_PRODUCTION }}" --force
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_PRODUCTION }}

      - name: Deploy Firestore indexes to production
        if: needs.validate-rules.outputs.indexes-changed == 'true'
        run: |
          echo "Deploying Firestore indexes to production..."
          firebase deploy --only firestore:indexes --project taxasge-prod --token "${{ secrets.FIREBASE_TOKEN_PRODUCTION }}" --force
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_PRODUCTION }}

      - name: Post-deployment verification
        run: |
          echo "Running post-deployment verification..."

          # Wait for deployment to propagate
          sleep 30

          # Add verification steps here
          echo "‚úÖ Production deployment completed successfully"

      - name: Notify deployment
        if: success()
        run: |
          echo "üöÄ Firebase rules deployed successfully to production"
          echo "Backup created at: backups/${{ env.BACKUP_TIMESTAMP }}"

      - name: Rollback on failure
        if: failure() && env.BACKUP_TIMESTAMP
        run: |
          echo "‚ùå Deployment failed, initiating rollback..."

          # Rollback firestore rules
          if [ -f backups/${{ env.BACKUP_TIMESTAMP }}/firestore.rules.backup ]; then
            firebase firestore:rules:deploy backups/${{ env.BACKUP_TIMESTAMP }}/firestore.rules.backup --project taxasge-prod --token "${{ secrets.FIREBASE_TOKEN_PRODUCTION }}"
          fi

          # Rollback storage rules
          if [ -f backups/${{ env.BACKUP_TIMESTAMP }}/storage.rules.backup ]; then
            firebase storage:rules:deploy backups/${{ env.BACKUP_TIMESTAMP }}/storage.rules.backup --project taxasge-prod --token "${{ secrets.FIREBASE_TOKEN_PRODUCTION }}"
          fi

          echo "üîÑ Rollback completed"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_PRODUCTION }}

  notification:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Notify success
        if: |
          needs.deploy-staging.result == 'success' ||
          needs.deploy-production.result == 'success'
        run: |
          echo "‚úÖ Firebase rules deployment completed successfully"
          # Add notification logic here (Slack, email, etc.)

      - name: Notify failure
        if: |
          needs.deploy-staging.result == 'failure' ||
          needs.deploy-production.result == 'failure'
        run: |
          echo "‚ùå Firebase rules deployment failed"
          # Add notification logic here (Slack, email, etc.)