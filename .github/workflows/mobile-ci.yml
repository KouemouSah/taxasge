# ============================================================================
# .github/workflows/mobile-ci-production.yml
# Script CI/CD mobile avec monitoring temps rÃ©el et notifications
# ============================================================================

name: ğŸ“± Mobile CI/CD Production

on:
  push:
    branches: ['feature/**', 'fix/**', 'develop', 'main']
    paths: ['packages/mobile/**']
  pull_request:
    branches: [develop, main]
    paths: ['packages/mobile/**']

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '11'

jobs:
  # ===== JOB 1: TESTS ET QUALITÃ‰ =====
  test:
    name: ğŸ§ª Tests & Quality Check
    runs-on: ubuntu-latest
    
    steps:
      # Ã‰tape 1: Checkout avec cache Git
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NÃ©cessaire pour SonarCloud
      
      # Ã‰tape 2: Setup Node.js avec cache intelligent
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: packages/mobile/yarn.lock
      
      # Ã‰tape 3: Installation des dÃ©pendances avec cache
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd packages/mobile
          yarn install --frozen-lockfile --prefer-offline
      
      # Ã‰tape 4: VÃ©rification de la qualitÃ© du code
      - name: ğŸ” Code Quality Check (ESLint + Prettier)
        run: |
          cd packages/mobile
          echo "::group::ESLint Analysis"
          yarn lint --format=compact --output-file=eslint-report.txt || true
          echo "::endgroup::"
          
          echo "::group::Prettier Check"
          yarn format:check
          echo "::endgroup::"
      
      # Ã‰tape 5: Tests unitaires avec coverage
      - name: ğŸ§ª Run Unit Tests
        run: |
          cd packages/mobile
          yarn test --coverage --watchAll=false --passWithNoTests
          
          # Affichage du rÃ©sumÃ© coverage dans GitHub Actions
          echo "::group::Coverage Summary"
          cat coverage/text-summary.txt || echo "No coverage report found"
          echo "::endgroup::"
      
      # Ã‰tape 6: Upload des artefacts de test
      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-test-results-${{ github.run_id }}
          path: |
            packages/mobile/coverage/
            packages/mobile/eslint-report.txt
          retention-days: 7
      
      # Ã‰tape 7: SonarCloud Analysis (gratuit pour projets publics)
      - name: ğŸ“ˆ SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        if: github.repository_owner == 'votre-organisation' # Remplacez par votre org
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} # Ã€ configurer dans GitHub Secrets
        with:
          projectBaseDir: packages/mobile
      
      # Ã‰tape 8: Build validation (sans APK complet)
      - name: ğŸ”¨ Validate Build
        run: |
          cd packages/mobile
          echo "::group::Metro Bundle Check"
          npx react-native bundle --platform android --dev false --entry-file index.js --bundle-output android-test.bundle --assets-dest /tmp || true
          echo "::endgroup::"

  # ===== JOB 2: BUILD ET DISTRIBUTION (DEVELOP SEULEMENT) =====
  build:
    name: ğŸ”¨ Build & Distribute
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Setup Java pour Android
      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      # Setup Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: packages/mobile/yarn.lock
      
      # Installation des dÃ©pendances
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd packages/mobile
          yarn install --frozen-lockfile
      
      # Build APK Debug
      - name: ğŸ”¨ Build Android APK (Debug)
        run: |
          cd packages/mobile/android
          echo "::group::Gradle Build"
          ./gradlew assembleDebug --no-daemon --parallel
          echo "::endgroup::"
          
          # VÃ©rification que l'APK existe
          if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
            echo "âœ… APK built successfully"
            ls -lh app/build/outputs/apk/debug/app-debug.apk
          else
            echo "âŒ APK build failed"
            exit 1
          fi
      
      # Distribution Firebase (remplacez les valeurs)
      - name: ğŸš€ Distribute to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_ANDROID_APP_ID }} # Ã€ configurer
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
          groups: testeurs-internes
          file: packages/mobile/android/app/build/outputs/apk/debug/app-debug.apk
          releaseNotes: |
            ğŸ”„ Auto-deployment from develop branch
            ğŸ“… Build: ${{ github.run_number }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Author: ${{ github.actor }}
            
            Changes in this build:
            ${{ github.event.head_commit.message }}

  # ===== JOB 3: NOTIFICATIONS =====
  notify:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()
    
    steps:
      - name: ğŸ“¨ Notify Slack/Discord
        uses: 8398a7/action-slack@v3
        if: env.SLACK_WEBHOOK_URL != ''
        with:
          status: ${{ job.status }}
          channel: '#taxasge-ci'
          username: 'TaxasGE Bot'
          icon_emoji: ':robot_face:'
          title: 'Mobile CI/CD Results'
          message: |
            ğŸ“± *Mobile Build Status*: ${{ needs.test.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}
            ğŸ”— *Branch*: `${{ github.ref_name }}`
            ğŸ‘¤ *Author*: ${{ github.actor }}
            ğŸ”— *View Details*: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ${{ needs.build.result == 'success' && 'ğŸ“¦ APK distributed to Firebase' || '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # Ã€ configurer
