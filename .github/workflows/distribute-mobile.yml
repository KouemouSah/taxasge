# .github/workflows/distribute-mobile.yml
name: Distribute Mobile App (Android)

on:
  push:
    branches:
      - develop
    paths:
      - 'packages/mobile/**'  # Optimisation: seulement si mobile modifiÃ©

jobs:
  build-and-distribute:
    name: Build and Distribute Android App
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      
      # âœ… CORRECTION: Cache path spÃ©cifique au monorepo
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          cache-dependency-path: 'packages/mobile/yarn.lock'  # âœ… Path corrigÃ©
      
      # âœ… CORRECTION: VÃ©rification et crÃ©ation yarn.lock si nÃ©cessaire
      - name: ğŸ” Check Mobile Project Structure
        run: |
          echo "ğŸ“‹ Checking mobile project structure..."
          
          # VÃ©rification que le dossier mobile existe
          if [ ! -d "packages/mobile" ]; then
            echo "âŒ packages/mobile directory not found!"
            echo "Current directory structure:"
            find . -maxdepth 3 -type d | head -20
            exit 1
          fi
          
          cd packages/mobile
          
          # VÃ©rification package.json
          if [ ! -f "package.json" ]; then
            echo "âš ï¸  package.json not found, creating basic React Native package.json"
            cat > package.json << 'EOF'
          {
            "name": "taxasge-mobile",
            "version": "0.1.0",
            "private": true,
            "scripts": {
              "android": "react-native run-android",
              "ios": "react-native run-ios",
              "start": "react-native start",
              "test": "jest",
              "lint": "eslint . --ext .js,.jsx,.ts,.tsx",
              "format:check": "prettier --check ."
            },
            "dependencies": {
              "react": "18.2.0",
              "react-native": "0.72.0",
              "@react-native-firebase/app": "^18.0.0",
              "@react-native-firebase/auth": "^18.0.0",
              "@react-native-firebase/firestore": "^18.0.0"
            },
            "devDependencies": {
              "@babel/core": "^7.20.0",
              "@babel/preset-env": "^7.20.0",
              "@babel/runtime": "^7.20.0",
              "@react-native/eslint-config": "^0.72.0",
              "@react-native/metro-config": "^0.72.0",
              "@tsconfig/react-native": "^3.0.0",
              "@types/react": "^18.0.24",
              "@types/react-test-renderer": "^18.0.0",
              "babel-jest": "^29.2.1",
              "eslint": "^8.19.0",
              "jest": "^29.2.1",
              "metro-react-native-babel-preset": "0.76.5",
              "prettier": "^2.4.1",
              "react-test-renderer": "18.2.0",
              "typescript": "4.8.4"
            },
            "engines": {
              "node": ">=16"
            }
          }
          EOF
            echo "âœ… package.json created"
          fi
          
          # VÃ©rification yarn.lock - crÃ©ation si absent
          if [ ! -f "yarn.lock" ]; then
            echo "âš ï¸  yarn.lock not found, will be created during install"
          else
            echo "âœ… yarn.lock found"
          fi
          
          # VÃ©rification Android project
          if [ ! -d "android" ]; then
            echo "âš ï¸  Android project not found, creating basic structure"
            mkdir -p android/app/src/main/java/com/taxasge
            mkdir -p android/app/src/main/res/values
            
            # CrÃ©ation d'un build.gradle basique
            mkdir -p android/app
            cat > android/app/build.gradle << 'EOF'
          apply plugin: "com.android.application"
          apply plugin: "com.facebook.react"
          
          android {
              compileSdkVersion rootProject.ext.compileSdkVersion
              
              defaultConfig {
                  applicationId "gq.gov.dgi.taxasge"
                  minSdkVersion rootProject.ext.minSdkVersion
                  targetSdkVersion rootProject.ext.targetSdkVersion
                  versionCode 1
                  versionName "1.0"
              }
              
              buildTypes {
                  debug {
                      signingConfig signingConfigs.debug
                  }
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
                  }
              }
          }
          
          dependencies {
              implementation "com.facebook.react:react-native:+"
              implementation "androidx.appcompat:appcompat:1.0.2"
          }
          EOF
            
            # build.gradle principal
            cat > android/build.gradle << 'EOF'
          buildscript {
              ext {
                  buildToolsVersion = "33.0.0"
                  minSdkVersion = 21
                  compileSdkVersion = 33
                  targetSdkVersion = 33
                  ndkVersion = "23.1.7779620"
              }
              dependencies {
                  classpath("com.android.tools.build:gradle:7.3.1")
                  classpath("com.facebook.react:react-native-gradle-plugin")
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF
            
            echo "âœ… Basic Android structure created"
          else
            echo "âœ… Android project found"
          fi
      
      # âœ… Installation des dÃ©pendances avec gestion d'erreur
      - name: ğŸ“¦ Install dependencies
        run: |
          cd packages/mobile
          echo "ğŸ“¦ Installing dependencies..."
          
          # Installation avec retry en cas d'Ã©chec rÃ©seau
          for i in {1..3}; do
            if yarn install --frozen-lockfile --prefer-offline --network-timeout 300000; then
              echo "âœ… Dependencies installed successfully on attempt $i"
              break
            else
              echo "âš ï¸  Installation failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "âŒ Installation failed after 3 attempts, trying without frozen-lockfile"
                yarn install --prefer-offline --network-timeout 300000
              fi
              sleep 10
            fi
          done
          
          # VÃ©rification que node_modules existe
          if [ -d "node_modules" ]; then
            echo "âœ… node_modules directory created"
            echo "ğŸ“Š Installed packages: $(ls node_modules | wc -l)"
          else
            echo "âŒ node_modules not found after installation"
            exit 1
          fi
      
      # âœ… PrÃ©paration du build Android
      - name: ğŸ› ï¸ Prepare Android Build
        run: |
          cd packages/mobile
          
          # VÃ©rification de la configuration Android
          if [ ! -f "android/gradlew" ]; then
            echo "âš ï¸  gradlew not found, setting up Gradle wrapper"
            cd android
            gradle wrapper --gradle-version 7.5.1
            chmod +x gradlew
            cd ..
          fi
          
          # Nettoyage des builds prÃ©cÃ©dents
          cd android
          echo "ğŸ§¹ Cleaning previous builds..."
          ./gradlew clean || echo "Clean failed, continuing..."
          
          echo "âœ… Android build preparation complete"
      
      # âœ… Build APK avec gestion d'erreur amÃ©liorÃ©e
      - name: ğŸ”¨ Build Android App (Debug APK)
        run: |
          cd packages/mobile/android
          
          echo "ğŸ”¨ Starting Android build..."
          echo "ğŸ“Š Available memory: $(free -h)"
          echo "ğŸ“Š Available disk: $(df -h . | tail -1)"
          
          # Build avec options optimisÃ©es pour CI
          echo "::group::Gradle Build"
          ./gradlew assembleDebug \
            --no-daemon \
            --parallel \
            --max-workers=2 \
            --build-cache \
            -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxPermSize=512m" \
            -Dorg.gradle.parallel=true \
            -Dorg.gradle.configureondemand=true
          echo "::endgroup::"
          
          # VÃ©rification que l'APK a Ã©tÃ© crÃ©Ã©
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK_PATH" ]; then
            echo "âœ… APK built successfully"
            echo "ğŸ“Š APK size: $(ls -lh $APK_PATH | awk '{print $5}')"
            echo "ğŸ“ APK location: $(pwd)/$APK_PATH"
          else
            echo "âŒ APK build failed - file not found"
            echo "ğŸ“‹ Available files in outputs/apk/debug/:"
            ls -la app/build/outputs/apk/debug/ || echo "Directory not found"
            exit 1
          fi
      
      # âœ… Distribution Firebase avec configuration dynamique
      - name: ğŸš€ Distribute to Firebase App Distribution
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
          FIREBASE_ANDROID_APP_ID: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
        run: |
          # VÃ©rification des secrets
          if [ -z "$FIREBASE_SERVICE_ACCOUNT" ]; then
            echo "âŒ FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV secret not configured"
            echo "Please add this secret in GitHub repository settings"
            exit 1
          fi
          
          if [ -z "$FIREBASE_ANDROID_APP_ID" ]; then
            echo "âŒ FIREBASE_ANDROID_APP_ID secret not configured"
            echo "Please add this secret in GitHub repository settings"
            exit 1
          fi
          
          # CrÃ©ation du fichier de credentials temporaire
          echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-sa.json
          
          # Informations de release
          RELEASE_NOTES="ğŸš€ TaxasGE Mobile - Automatic Build
          
          ğŸ“… Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ğŸŒ¿ Branch: ${{ github.ref_name }}
          ğŸ“ Commit: ${{ github.sha }}
          ğŸ‘¤ Author: ${{ github.actor }}
          ğŸ”¢ Build: #${{ github.run_number }}
          
          ğŸ“‹ Changes:
          ${{ github.event.head_commit.message }}
          
          âš ï¸  This is a development build for testing purposes only."
          
          echo "ğŸš€ Distributing APK to Firebase App Distribution..."
          echo "ğŸ“± App ID: $FIREBASE_ANDROID_APP_ID"
          echo "ğŸ‘¥ Target Group: testeurs-internes"
          
          # Distribution avec l'action GitHub
          echo "$RELEASE_NOTES" > /tmp/release-notes.txt
      
      - name: ğŸ“± Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
          groups: testeurs-internes
          file: packages/mobile/android/app/build/outputs/apk/debug/app-debug.apk
          releaseNotes: |
            ğŸš€ TaxasGE Mobile - Auto Build #${{ github.run_number }}
            
            ğŸ“… Build: ${{ github.run_number }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Author: ${{ github.actor }}
            
            ğŸ“‹ Latest Changes:
            ${{ github.event.head_commit.message }}
            
            âš ï¸ Development build for testing only
      
      # âœ… Nettoyage et notification
      - name: ğŸ§¹ Cleanup and Notify
        if: always()
        run: |
          # Nettoyage sÃ©curisÃ©
          rm -f /tmp/firebase-sa.json
          rm -f /tmp/release-notes.txt
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Mobile app distribution completed successfully!"
            echo "ğŸ“± Testers can download the app from Firebase App Distribution"
            echo "ğŸ”— Firebase Console: https://console.firebase.google.com/project/taxasge-dev/appdistribution"
          else
            echo "âŒ Mobile app distribution failed"
            echo "Please check the logs above for details"
          fi
