# ============================================================================
# ğŸ“² TaxasGE Mobile Distribution - Firebase App Distribution
# ============================================================================
# Workflow de distribution automatique des builds mobiles vers les testeurs
# DÃ©clenchÃ© sur: Release tags + dÃ©ploiement manuel
#
# Features:
# - Build APK/IPA optimisÃ©s pour distribution
# - Upload automatique Firebase App Distribution
# - Notification testeurs avec release notes
# - Distribution diffÃ©renciÃ©e dev/prod
# - Gestion des versions et mÃ©tadonnÃ©es
# - IntÃ©gration avec les releases GitHub
#
# Author: KOUEMOU SAH Jean Emac
# ============================================================================

name: ğŸ“² Distribute Mobile App

on:
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de distribution'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
      build_type:
        description: 'Type de build'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      notify_testers:
        description: 'Notifier les testeurs'
        required: false
        default: true
        type: boolean
      release_notes:
        description: 'Notes de version (optionnel)'
        required: false
        type: string

# ============================================================================
# VARIABLES GLOBALES
# ============================================================================

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  FIREBASE_CLI_VERSION: '12.9.1'
  FIREBASE_PROJECT_DEV: 'taxasge-dev'
  FIREBASE_PROJECT_PROD: 'taxasge-prod'
  APP_ID_ANDROID_DEV: '1:392159428433:android:877edaeebd6f9558ef1d70' # Ã€ remplacer par le vrai ID
  APP_ID_ANDROID_PROD: '1:430718042574:android:ae49f5671d0e22b7162b9f' # Ã€ remplacer par le vrai ID

# ============================================================================
# JOBS DE DISTRIBUTION
# ============================================================================

jobs:
  # ==========================================================================
  # JOB 1: PRÃ‰PARATION DISTRIBUTION
  # ==========================================================================
  
  prepare-distribution:
    name: ğŸ”§ Prepare Distribution
    runs-on: ubuntu-latest
    
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      build-type: ${{ steps.config.outputs.build-type }}
      firebase-project: ${{ steps.config.outputs.firebase-project }}
      app-id: ${{ steps.config.outputs.app-id }}
      version-name: ${{ steps.config.outputs.version-name }}
      version-code: ${{ steps.config.outputs.version-code }}
      release-notes: ${{ steps.config.outputs.release-notes }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Configure distribution parameters
        id: config
        run: |
          # DÃ©terminer l'environnement
          if [[ "${{ github.event_name }}" == "release" ]]; then
            if [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
              ENVIRONMENT="development"
              BUILD_TYPE="debug"
            else
              ENVIRONMENT="production"
              BUILD_TYPE="release"
            fi
          else
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            BUILD_TYPE="${{ github.event.inputs.build_type }}"
          fi
          
          # Configuration Firebase selon environnement
          if [[ "$ENVIRONMENT" == "production" ]]; then
            FIREBASE_PROJECT="${{ env.FIREBASE_PROJECT_PROD }}"
            APP_ID="${{ env.APP_ID_ANDROID_PROD }}"
          else
            FIREBASE_PROJECT="${{ env.FIREBASE_PROJECT_DEV }}"
            APP_ID="${{ env.APP_ID_ANDROID_DEV }}"
          fi
          
          # GÃ©nÃ©ration version
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION_NAME="${{ github.event.release.tag_name }}"
          else
            VERSION_NAME="v$(date +%Y.%m.%d)-$ENVIRONMENT"
          fi
          VERSION_CODE=$(date +%s)
          
          # Notes de version
          if [[ "${{ github.event_name }}" == "release" ]]; then
            RELEASE_NOTES="${{ github.event.release.body }}"
          elif [[ -n "${{ github.event.inputs.release_notes }}" ]]; then
            RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
          else
            RELEASE_NOTES="Build automatique $VERSION_NAME pour $ENVIRONMENT"
          fi
          
          # Outputs
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "build-type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "firebase-project=$FIREBASE_PROJECT" >> $GITHUB_OUTPUT
          echo "app-id=$APP_ID" >> $GITHUB_OUTPUT
          echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT
          # Use heredoc to safely handle multiline release notes
          echo "release-notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Distribution Summary
        run: |
          echo "ğŸ“² TaxasGE Mobile Distribution"
          echo "=============================="
          echo "ğŸ¯ Environment: ${{ steps.config.outputs.environment }}"
          echo "ğŸ—ï¸ Build Type: ${{ steps.config.outputs.build-type }}"
          echo "ğŸ”¥ Firebase: ${{ steps.config.outputs.firebase-project }}"
          echo "ğŸ“± App ID: ${{ steps.config.outputs.app-id }}"
          echo "ğŸ·ï¸ Version: ${{ steps.config.outputs.version-name }}"
          echo "ğŸ”¢ Code: ${{ steps.config.outputs.version-code }}"
          echo "ğŸ“ Notes: ${{ steps.config.outputs.release-notes }}"

  # ==========================================================================
  # JOB 2: BUILD ANDROID OPTIMISÃ‰
  # ==========================================================================
  
  build-android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: prepare-distribution
    outputs:
      apk_path: ${{ steps.build_apk.outputs.apk_path }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: packages/mobile/yarn.lock

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: ğŸ“¦ Install dependencies
        run: |
          cd packages/mobile

          if [[ ! -f "package.json" ]] || [[ ! -s "package.json" ]]; then
            echo "âŒ package.json manquant ou vide"
            echo "ğŸ“ Structure mobile non prÃªte pour distribution"
            exit 1
          fi

          echo "ğŸ“¦ Installation des dÃ©pendances pour distribution..."
          yarn install  --production=false --network-timeout 300000

      - name: ğŸ”¥ Setup Firebase Mobile Configs
        run: |
          cd packages/mobile
          echo "ğŸ”¥ Setting up Firebase configs for: ${{ needs.prepare-distribution.outputs.environment }}"

          if [[ "${{ needs.prepare-distribution.outputs.environment }}" == "production" ]]; then
            echo "ğŸš€ Copying PRODUCTION Firebase configs..."
            cp ../../config/google-services.prod.json android/app/google-services.json
            cp ../../config/GoogleService-Info.pro.plist ios/GoogleService-Info.plist
            echo "âœ… Production configs applied"
          else
            echo "ğŸ“± Copying DEVELOPMENT Firebase configs..."
            cp ../../config/google-services.dev.json android/app/google-services.json
            cp ../../config/GoogleService-Info.dev.plist ios/GoogleService-Info.plist
            echo "âœ… Development configs applied"
          fi

          # VÃ©rifier que les fichiers ont Ã©tÃ© copiÃ©s
          if [ -f "android/app/google-services.json" ]; then
            PROJECT_ID=$(grep -o '"project_id": "[^"]*"' android/app/google-services.json | cut -d'"' -f4)
            echo "ğŸ“Š Android Firebase Project: $PROJECT_ID"
          fi

          if [ -f "ios/GoogleService-Info.plist" ]; then
            PROJECT_ID=$(grep -A 1 "PROJECT_ID" ios/GoogleService-Info.plist | grep "<string>" | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
            echo "ğŸ“Š iOS Firebase Project: $PROJECT_ID"
          fi

      - name: ğŸ”§ Configure build environment
        env:
          ENVIRONMENT: ${{ needs.prepare-distribution.outputs.environment }}
          VERSION_NAME: ${{ needs.prepare-distribution.outputs.version-name }}
          VERSION_CODE: ${{ needs.prepare-distribution.outputs.version-code }}
        run: |
          cd packages/mobile
          
          # VÃ©rifier structure Android
          if [[ ! -d "android" ]] || [[ ! -f "android/gradlew" ]]; then
            echo "âŒ Structure Android manquante"
            echo "ğŸ“ Initialisation React Native Android requise"
            exit 1
          fi
          
          echo "ğŸ”§ Configuration build pour $ENVIRONMENT"
          
          # Mettre Ã  jour versionName et versionCode dans build.gradle
          if [[ -f "android/app/build.gradle" ]]; then
            sed -i "s/versionName \".*\"/versionName \"$VERSION_NAME\"/" android/app/build.gradle
            sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
            echo "âœ… Version mise Ã  jour: $VERSION_NAME ($VERSION_CODE)"
          fi
          
          # Validation configuration Firebase
          if [[ -f "android/app/google-services.json" ]]; then
            echo "âœ… google-services.json prÃ©sent"
            
            # VÃ©rifier cohÃ©rence projet Firebase avec environnement
            PROJECT_ID=$(grep -o '"project_id": "[^"]*"' android/app/google-services.json | cut -d'"' -f4)
            
            if [[ "$ENVIRONMENT" == "production" && "$PROJECT_ID" != "taxasge-prod" ]]; then
              echo "âš ï¸ WARNING: Configuration Firebase dev dÃ©tectÃ©e pour environnement production"
              echo "ğŸ“ ConsidÃ©rer la gestion par branches (developâ†’taxasge-dev, mainâ†’taxasge-prod)"
            elif [[ "$ENVIRONMENT" == "development" && "$PROJECT_ID" != "taxasge-dev" ]]; then
              echo "âš ï¸ WARNING: Configuration Firebase prod dÃ©tectÃ©e pour environnement development"
              echo "ğŸ“ ConsidÃ©rer la gestion par branches (developâ†’taxasge-dev, mainâ†’taxasge-prod)"
            else
              echo "âœ… Configuration Firebase cohÃ©rente: $PROJECT_ID pour $ENVIRONMENT"
            fi
          else
            echo "âŒ google-services.json manquant"
            echo "ğŸ“ Configuration Firebase Android requise"
            exit 1
          fi

      - name: ğŸ—ï¸ Build Android APK
        id: build_apk
        env:
          BUILD_TYPE: ${{ needs.prepare-distribution.outputs.build-type }}
        run: |
          cd packages/mobile/android
          
          echo "ğŸ—ï¸ Build Android $BUILD_TYPE..."
          
          # Nettoyer le projet
          ./gradlew clean
          
          # Build selon le type
          if [[ "$BUILD_TYPE" == "release" ]]; then
            echo "ğŸš€ Building release APK..."
            ./gradlew assembleRelease
            APK_PATH="app/build/outputs/apk/release/app-release.apk"
          else
            echo "ğŸ”§ Building debug APK..."
            ./gradlew assembleDebug
            APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          fi
          
          # VÃ©rifier gÃ©nÃ©ration
          if [[ -f "$APK_PATH" ]]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "âœ… APK gÃ©nÃ©rÃ©: $APK_SIZE"
            echo "apk_path=$APK_PATH" >> $GITHUB_ENV
          else
            echo "âŒ Ã‰chec gÃ©nÃ©ration APK"
            exit 1
          fi

      - name: ğŸ“Š APK Info
        run: |
          cd packages/mobile/android
          
          if [[ -f "${{ env.apk-path }}" ]]; then
            echo "ğŸ“± APK Information:"
            echo "Path: ${{ env.apk-path }}"
            echo "Size: $(du -h "${{ env.apk-path }}" | cut -f1)"
            echo "SHA256: $(sha256sum "${{ env.apk-path }}" | cut -d' ' -f1)"
          fi

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: taxasge-android-${{ needs.prepare-distribution.outputs.environment }}-${{ needs.prepare-distribution.outputs.version-name }}
          path: packages/mobile/android/${{ steps.build_apk.outputs.apk_path }}
          retention-days: 90

  # ==========================================================================
  # JOB 3: DISTRIBUTION FIREBASE
  # ==========================================================================
  
  distribute-firebase:
    name: ğŸ”¥ Firebase App Distribution
    runs-on: ubuntu-latest
    needs: [prepare-distribution, build-android]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”¥ Install Firebase CLI
        run: |
          npm install -g firebase-tools@${{ env.FIREBASE_CLI_VERSION }}
          firebase --version

      - name: ğŸ“¥ Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: taxasge-android-${{ needs.prepare-distribution.outputs.environment }}-${{ needs.prepare-distribution.outputs.version-name }}
          path: ./artifacts/

      - name: ğŸ”¥ Firebase Authentication
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ needs.prepare-distribution.outputs.environment == 'production' && secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_PRO || secrets.FIREBASE_SERVICE_ACCOUNT_TAXASGE_DEV }}
        run: |
          # CrÃ©er le fichier service account
          echo "$FIREBASE_SERVICE_ACCOUNT" > service-account.json

          # VÃ©rifier que le service account a Ã©tÃ© crÃ©Ã© correctement
          if [ ! -s "service-account.json" ]; then
            echo "âŒ Erreur: Le service account est vide ou n'a pas Ã©tÃ© crÃ©Ã©"
            exit 1
          fi

          # DÃ©finir la variable d'environnement pour l'authentification automatique
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/service-account.json"

          # VÃ©rifier le contenu du service account (sans l'afficher pour des raisons de sÃ©curitÃ©)
          if ! jq . service-account.json > /dev/null 2>&1; then
            echo "âŒ Erreur: Le service account n'est pas un JSON valide"
            exit 1
          fi

          # SÃ©lectionner le projet Firebase selon l'environnement
          firebase use ${{ needs.prepare-distribution.outputs.firebase-project }}

          # VÃ©rifier l'authentification en listant les projets
          firebase projects:list

          echo "âœ… Authentification Firebase rÃ©ussie pour ${{ needs.prepare-distribution.outputs.firebase-project }}"

      - name: ğŸ“² Distribute to App Distribution
        env:
          FIREBASE_PROJECT: ${{ needs.prepare-distribution.outputs.firebase-project }}
          APP_ID: ${{ needs.prepare-distribution.outputs.app-id }}
          RELEASE_NOTES: ${{ needs.prepare-distribution.outputs.release-notes }}
          NOTIFY_TESTERS: ${{ github.event.inputs.notify_testers || 'true' }}
        run: |
          # Trouver le fichier APK
          APK_FILE=$(find ./artifacts/ -name "*.apk" | head -1)
          
          if [[ -z "$APK_FILE" ]]; then
            echo "âŒ Aucun fichier APK trouvÃ©"
            exit 1
          fi
          
          echo "ğŸ“² Distribution via Firebase App Distribution..."
          echo "Project: $FIREBASE_PROJECT"
          echo "App ID: $APP_ID"
          echo "APK: $APK_FILE"
          
          # Configuration du projet Firebase
          firebase use $FIREBASE_PROJECT
          
          # Distribution avec notes de version
          DISTRIBUTE_CMD="firebase appdistribution:distribute \"$APK_FILE\" --app \"$APP_ID\""
          
          if [[ -n "$RELEASE_NOTES" ]]; then
            DISTRIBUTE_CMD="$DISTRIBUTE_CMD --release-notes \"$RELEASE_NOTES\""
          fi
          
          # Groupes de testeurs selon environnement
          if [[ "${{ needs.prepare-distribution.outputs.environment }}" == "production" ]]; then
            DISTRIBUTE_CMD="$DISTRIBUTE_CMD --groups \"beta-testers,stakeholders\""
          else
            DISTRIBUTE_CMD="$DISTRIBUTE_CMD --groups \"internal-testers,developers\""
          fi
          
          # Notifications conditionnelles
          if [[ "$NOTIFY_TESTERS" == "false" ]]; then
            echo "ğŸ“µ Notifications testeurs dÃ©sactivÃ©es"
          fi
          
          # ExÃ©cuter la distribution
          eval $DISTRIBUTE_CMD
          
          echo "âœ… Distribution Firebase rÃ©ussie !"

  # ==========================================================================
  # JOB 4: NOTIFICATIONS & SUIVI
  # ==========================================================================
  
  notify:
    name: ğŸ“¢ Notifications Distribution
    runs-on: ubuntu-latest
    needs: [prepare-distribution, build-android, distribute-firebase]
    if: always()

    steps:
      - name: ğŸ“Š Determine distribution status
        id: status
        run: |
          if [[ "${{ needs.build-android.result }}" == "success" && "${{ needs.distribute-firebase.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "color=#00d084" >> $GITHUB_OUTPUT
            echo "message=Distribution rÃ©ussie" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.build-android.result }}" == "success" ]]; then
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
            echo "color=#ffa500" >> $GITHUB_OUTPUT
            echo "message=Build rÃ©ussi, distribution Ã©chouÃ©e" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "color=#ff4757" >> $GITHUB_OUTPUT
            echo "message=Build Ã©chouÃ©" >> $GITHUB_OUTPUT
          fi

      
      
      - name: Check Slack Webhook Availability
        id: check-slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "has_slack_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_slack_webhook=false" >> $GITHUB_OUTPUT
          fi
            
      
      - name: ğŸ“¢ Slack notification
        if: steps.check-slack.outputs.has_slack_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} TaxasGE Mobile Distribution - ${{ steps.status.outputs.status }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "${{ needs.prepare-distribution.outputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "Version",
                      "value": "${{ needs.prepare-distribution.outputs.version-name }}",
                      "short": true
                    },
                    {
                      "title": "Build Type",
                      "value": "${{ needs.prepare-distribution.outputs.build-type }}",
                      "short": true
                    },
                    {
                      "title": "Firebase Project",
                      "value": "${{ needs.prepare-distribution.outputs.firebase-project }}",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "${{ steps.status.outputs.message }}",
                      "short": false
                    },
                    {
                      "title": "Release Notes",
                      "value": "${{ needs.prepare-distribution.outputs.release-notes }}",
                      "short": false
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“Š Distribution Summary
        run: |
          echo "ğŸ“² TaxasGE Mobile Distribution Summary"
          echo "====================================="
          echo "ğŸ¯ Environment: ${{ needs.prepare-distribution.outputs.environment }}"
          echo "ğŸ·ï¸ Version: ${{ needs.prepare-distribution.outputs.version-name }}"
          echo "ğŸ—ï¸ Build: ${{ needs.build-android.result }}"
          echo "ğŸ”¥ Distribution: ${{ needs.distribute-firebase.result }}"
          echo "ğŸ“Š Overall: ${{ steps.status.outputs.status }}"
          echo ""
          echo "ğŸ“ Release Notes:"
          echo "${{ needs.prepare-distribution.outputs.release-notes }}"

# ============================================================================
# CONCURRENCY CONTROL
# ============================================================================
concurrency:
  group: distribute-mobile-${{ github.ref }}-${{ github.event.inputs.environment }}
  cancel-in-progress: false # Ne pas annuler les distributions en cours

# ============================================================================
# WORKFLOW SUMMARY
# ============================================================================
# Ce workflow Mobile Distribution pour TaxasGE effectue:
# 1. ğŸ”§ PrÃ©paration paramÃ¨tres distribution (version, environment, notes)
# 2. ğŸ¤– Build Android APK optimisÃ© (debug/release selon contexte)
# 3. ğŸ”¥ Distribution Firebase App Distribution avec groupes testeurs
# 4. ğŸ“¢ Notifications Ã©quipe et testeurs
#
# DÃ©clenchÃ© sur: Release GitHub + workflow_dispatch manuel
# Compatible avec: Environments dev/prod, Build types debug/release
# Features: Versioning automatique, groupes testeurs, release notes
# ============================================================================